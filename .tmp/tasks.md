# タスクリスト - Google シートバックエンド REST API サービス

## 概要

- 総タスク数: 12
- 推定作業時間: 77-97時間
- 優先度: 高
- **🚨 絶対遵守事項**: モック禁止・テストスキップ禁止・フォールバック禁止
- **🚀 常時デプロイ方針**: 各タスク完了時に本番環境デプロイ・動作確認を実施

## 🚨 重要制約事項

### 絶対禁止項目
1. **モック禁止**: モックデータ・モック関数の使用は絶対禁止
2. **テストスキップ禁止**: テストのスキップは絶対禁止
3. **フォールバック原則禁止**: フォールバックは原則禁止。ただしキャッシュミス時に限り、読み取り要求は自動でGoogleシートからのフェッチにフォールバックして差分を適用することを許可する
   - **許可される唯一のフォールバック**: キャッシュミス時の読み取り → Googleシート自動フェッチ
   - **禁止**: 書き込み操作のフォールバック（エラー時は明確に失敗）
   - **禁止**: エラー時の代替値返却・デフォルト値設定
   - **必須**: フォールバック発生時の明示的ログ出力
   - **必須**: フォールバック発生の監視・アラート設定

### 機能ベース実装方針
- **機能単位**: UI + API を同時実装
- **実環境確認**: 機能完成時に画面で実環境動作確認
- **Googleシート活用**: ユーザー・データ管理はGoogleシートで実施
- **管理画面**: システム設定（configテーブル）の編集のみ

## タスク一覧

### Phase 1: プロジェクト基盤

#### Task 1.1: プロジェクト初期化・デプロイ環境構築 ✅

- [x] ドキュメント作成完了（.tmp/tasks/1.1-project-initialization.md）
- [x] package.json作成とTypeScript設定
- [x] Hono + React(JSX) 統合環境構築
- [x] Hono + Cloudflare Workers 基本設定
- [x] wrangler.toml 設定ファイル作成（本番・開発環境）
- [x] ESLint, Prettier 設定
- [x] Vitest テスト環境構築（実環境接続設定）
- [x] **Playwright テスト環境構築**（Chrome使用、ブラウザテスト）
- [x] **GitHub Actions CI/CD設定**（自動テスト・自動デプロイ）
- [x] **Cloudflare Workers本番環境設定**
- [x] **環境変数管理設定**（開発・本番分離）
- [x] **初回デプロイ実施・動作確認**
- **完了条件**: `npm run dev`, `npm run build`, `npm run test`, `npm run test:e2e` が正常実行 + **本番環境デプロイ成功** ✅
- **依存**: なし
- **推定時間**: 6時間
- **実績**: 完了（PR #3）

#### Task 1.2: 基盤UI・API構築 ✅

- [x] ドキュメント作成完了（.tmp/tasks/1.2-foundation-ui-api.md）
- [x] Hono JSX レイアウトコンポーネント作成
- [x] ヘッダー・サイドバー実装
- [x] ダッシュボード画面実装
- [x] システム設定画面実装
- [x] 初期設定画面実装
- [x] Hono アプリケーション基本構造
- [x] ヘルスチェックエンドポイント (`/api/health`)
- [x] バージョンエンドポイント (`/api/version`)
- [x] CORS・基本ミドルウェア
- [x] **本番環境デプロイ・動作確認**
- **完了条件**: 管理画面レイアウト表示 + `/api/health` 動作確認 + **本番環境で動作** ✅
- **依存**: Task 1.1
- **推定時間**: 5時間
- **実績**: 完了（PR #5）

#### Task 1.3: D1データベース基盤 ✅

- [x] Drizzle ORM設定
- [x] 全テーブルスキーマ定義（config, cache_entries, user_sessions, rate_limits）
- [x] マイグレーション作成
- [x] データベースクライアント実装
- [x] 接続テスト実行
- [x] **本番D1データベース作成・マイグレーション実行**
- [x] **本番環境デプロイ・動作確認**
- **完了条件**: D1データベース接続・基本操作確認 + **本番環境で動作** ✅
- **依存**: Task 1.2
- **推定時間**: 5時間
- **実績**: 完了（PR #4）

### Phase 2: 初期設定・Google連携

#### Task 2.1: Google認証・シート選択機能実装

- [ ] Google OAuth2 設定（開発・本番環境）
- [ ] 初期設定画面UI実装
- [ ] シート選択UI実装
- [ ] `/api/setup/google-auth` エンドポイント
- [ ] `/api/setup/sheets` エンドポイント（シート一覧）
- [ ] `/api/setup/select-sheet` エンドポイント
- [ ] Google API クライアント設定
- [ ] 設定保存機能（D1 configテーブル）
- [ ] 画面での初期設定動作確認
- [ ] **本番環境デプロイ・動作確認**
- **完了条件**: 管理画面でGoogle認証・シート選択が実環境で完全動作 + **本番環境で動作**
- **依存**: Task 1.3
- **推定時間**: 9時間

#### Task 2.2: システム設定管理機能実装

- [ ] システム設定画面UI実装
- [ ] configテーブル管理API実装
- [ ] 設定項目定義（Googleクライアントキー、最大ファイルサイズ、キャッシュTTL等）
- [ ] 設定値バリデーション
- [ ] 設定変更の即座反映
- [ ] 画面での設定管理確認
- [ ] **本番環境デプロイ・動作確認**
- **完了条件**: システム設定がconfigテーブル経由で管理画面から変更可能 + **本番環境で動作**
- **依存**: Task 2.1
- **推定時間**: 6時間

### Phase 3: 認証・セキュリティシステム

#### Task 3.1: 認証システム実装

- [ ] ログインフォームUI実装
- [ ] JWT生成・検証ユーティリティ
- [ ] `/api/auth/login` エンドポイント（_Usersシート連携）
- [ ] `/api/auth/refresh` エンドポイント
- [ ] `/api/auth/logout` エンドポイント
- [ ] 認証ミドルウェア実装
- [ ] セッション管理（D1テーブル使用）
- [ ] 認証状態管理 (Zustand)
- [ ] 画面でのログイン・ログアウト確認
- [ ] **本番環境デプロイ・動作確認**
- **完了条件**: ログイン機能が実環境で動作（_Usersシートから認証） + **本番環境で動作**
- **依存**: Task 2.2
- **推定時間**: 8時間

#### Task 3.2: セキュリティ・レート制限実装

- [ ] レート制限ミドルウェア
- [ ] セキュリティログ実装
- [ ] CORS設定強化
- [ ] レート制限統計表示画面
- [ ] 画面でのレート制限動作確認
- [ ] **本番環境デプロイ・動作確認**
- **完了条件**: セキュリティ機能が実環境で動作・確認可能 + **本番環境で動作**
- **依存**: Task 3.1
- **推定時間**: 5時間

### Phase 4: データAPI・権限システム

#### Task 4.1: Google Sheets連携API実装

- [ ] SheetsService クラス実装
- [ ] シートデータ取得・更新・削除API
- [ ] `/api/sheets/{sheetName}` エンドポイント群
- [ ] カラム設定解析・バリデーション
- [ ] バッチ処理機能
- [ ] エラーハンドリング・リトライ
- [ ] APIテスト実行
- [ ] **本番環境デプロイ・動作確認**
- **完了条件**: Google Sheets データ操作APIが実環境で動作 + **本番環境で動作**
- **依存**: Task 3.2
- **推定時間**: 9時間

#### Task 4.2: ACL・権限制御実装

- [ ] _Rolesシート連携実装
- [ ] AclService クラス実装
- [ ] 行レベル権限チェック機能（6項目）
- [ ] ユーザー・ロール権限解決
- [ ] 権限フィルタリング機能
- [ ] データAPI権限統合
- [ ] 権限テスト実行
- [ ] **本番環境デプロイ・動作確認**
- **完了条件**: データ権限制御が実環境で動作 + **本番環境で動作**
- **依存**: Task 4.1
- **推定時間**: 9時間

### Phase 5: キャッシュ・ファイル管理

#### Task 5.1: キャッシュシステム実装

- [ ] CacheService クラス実装
- [ ] TTL管理機能
- [ ] キャッシュ無効化機能
- [ ] バックグラウンド更新機能
- [ ] データAPI キャッシュ統合
- [ ] キャッシュ統計画面
- [ ] 画面でのキャッシュ動作確認
- [ ] **本番環境デプロイ・動作確認**
- **完了条件**: キャッシュシステムが実環境で完全動作 + **本番環境で動作**
- **依存**: Task 4.2
- **推定時間**: 7時間

#### Task 5.2: ファイル管理システム実装

- [ ] ファイルアップロードAPI実装
- [ ] Cloudflare R2 統合
- [ ] _Files シート連携
- [ ] ファイル権限制御
- [ ] ファイル管理統計画面
- [ ] 画面でのファイル管理確認
- [ ] **本番環境デプロイ・動作確認**
- **完了条件**: ファイル管理が実環境で完全動作 + **本番環境で動作**
- **依存**: Task 5.1
- **推定時間**: 8時間

### Phase 6: 監視・本番運用

#### Task 6.1: システム監視実装

- [ ] システム統計表示画面
- [ ] API使用量表示
- [ ] エラーログ表示機能
- [ ] パフォーマンス監視機能
- [ ] 統計データ取得API
- [ ] 画面での監視機能確認
- [ ] **本番環境デプロイ・動作確認**
- **完了条件**: システム監視が実環境で完全動作 + **本番環境で動作**
- **依存**: Task 5.2
- **推定時間**: 6時間

#### Task 6.2: 統合テスト・品質確保

- [ ] フルスタック統合テスト作成（Vitest、実環境使用）
- [ ] **Playwright E2Eテストシナリオ実装**（Chrome、実環境使用）
  - [ ] 初期設定フロー（Google認証・シート選択）
  - [ ] ログイン・ログアウトフロー
  - [ ] データCRUD操作フロー
  - [ ] 権限制御確認フロー
  - [ ] ファイルアップロード・ダウンロードフロー
- [ ] パフォーマンステスト（実環境負荷）
- [ ] セキュリティテスト（実環境攻撃）
- [ ] 全要件確認テスト
- [ ] 品質確保・バグ修正
- **完了条件**: 全テスト（Vitest + Playwright）が実環境で通過し、要件を満たす
- **依存**: Task 6.1
- **推定時間**: 10時間

#### Task 6.3: 本番環境最終確認・ドキュメント整備

- [ ] 全機能の本番環境動作最終確認
- [ ] DNS設定・カスタムドメイン設定
- [ ] 監視・アラート設定（Cloudflare Analytics等）
- [ ] セキュリティ設定最終確認
- [ ] API ドキュメント整備
- [ ] 運用ドキュメント作成
- [ ] デプロイ手順書作成
- [ ] トラブルシューティングガイド作成
- **完了条件**: 本番環境完全動作 + 完全なドキュメント整備完了
- **依存**: Task 6.2
- **推定時間**: 4時間

## 実装順序の重要ポイント

### 正しい役割分担
- **Googleシート**: ユーザー管理・ロール管理・データ管理・ACL設定
- **管理画面**: システム設定（configテーブル）・統計表示・監視
- **API**: データアクセス・認証・権限チェック・キャッシュ

### 各Phaseの完了基準（本番環境動作必須）
- **Phase 1**: 基盤が本番環境で動作
- **Phase 2**: 初期設定・システム設定管理が本番環境で動作
- **Phase 3**: 認証・セキュリティが本番環境で動作
- **Phase 4**: データAPI・権限制御が本番環境で動作
- **Phase 5**: キャッシュ・ファイル管理が本番環境で動作
- **Phase 6**: 全機能が本番環境で完全動作 + ドキュメント完備

### 依存関係重要パス
```
Task 1.1 → Task 1.2 → Task 1.3
              ↓
Task 2.1 → Task 2.2
              ↓
Task 3.1 → Task 3.2
              ↓
Task 4.1 → Task 4.2
              ↓
Task 5.1 → Task 5.2
              ↓
Task 6.1 → Task 6.2 → Task 6.3
```

## 🚨 絶対遵守事項

### 役割分担の徹底
- **Googleシートでできることは管理画面に作らない**
- **システム設定のみ管理画面で管理**
- **データ管理はGoogleシートで実施**

### 品質管理
- 各タスク完了時に必ず実環境テスト実行
- コミット前にlint・typecheck必須
- 300行制限を各ファイルで厳守
- **モック使用発見時は即座に削除**

### エラーハンドリング
- **フォールバック原則禁止**: エラー時は明確な失敗を返す
  - **例外**: キャッシュミス時の読み取りのみGoogleシート自動フェッチを許可
  - 書き込み操作は失敗時に絶対フォールバックしない
- 具体的なエラーメッセージを表示
- ログに詳細なエラー情報を記録
- **フォールバック発生時**: 明示的ログ出力 + 監視アラート設定必須

### テスト戦略
- **テストスキップ絶対禁止**
- 実環境・実データでのテスト実施
- **Vitest**: ユニットテスト・統合テスト（80%以上カバレッジ）
- **Playwright**: E2Eテスト（Chrome使用、実際のユーザーフロー検証）
- CI/CDで両方のテストを自動実行

## 実装開始ガイド

1. **Task 1.1から順次実装開始**
   - 各タスク開始時にTodoWriteでin_progressに更新
   - 完了時はcompletedに更新

2. **機能単位での確認（本番環境必須）**
   - UI + API 実装後：画面で実環境動作確認
   - **本番環境デプロイ・動作確認**（各タスク完了時）
   - 問題発生時：画面で即座に確認・修正
   - 次の機能：前の機能が本番環境で完全動作後に開始

3. **役割分担の確認**
   - システム設定：管理画面で管理
   - データ管理：Googleシートで管理
   - 統計・監視：管理画面で表示