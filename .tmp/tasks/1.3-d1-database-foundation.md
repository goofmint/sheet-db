# Task 1.3: D1データベース基盤

## 概要

Cloudflare D1データベースの基盤を構築し、Drizzle ORMを使用したスキーマ定義とマイグレーションを実装します。システム設定、キャッシュ、セッション、レート制限の4つのテーブルを作成します。

## 目標

- Drizzle ORMの設定完了
- 全テーブルスキーマ定義（config, cache_entries, user_sessions, rate_limits）
- マイグレーション作成とローカル・本番環境での実行
- データベースクライアント実装とテスト
- 本番D1データベース作成・動作確認

## 技術スタック

- **ORM**: Drizzle ORM
- **データベース**: Cloudflare D1 (SQLite)
- **マイグレーション**: Drizzle Kit
- **型安全性**: TypeScript strict mode

## データベース設計

### テーブル一覧

#### 1. config テーブル

システム全体の設定を管理するキーバリューストア。

**用途:**
- Google Sheets ID
- Google API クライアント設定
- システム全体の設定値

**スキーマ:**
```typescript
interface ConfigTable {
  key: string;           // Primary key: 設定キー（例: "SHEET_ID", "MAX_FILE_SIZE"）
  value: string;         // 設定値（JSON文字列も可）
  description: string;   // 設定の説明
  updated_at: number;    // 更新日時（UNIX timestamp）
}
```

**インデックス:**
- PRIMARY KEY: key

#### 2. cache_entries テーブル

Google Sheets APIレスポンスのキャッシュを保存。

**用途:**
- シートデータのキャッシュ
- TTL管理
- パフォーマンス向上

**スキーマ:**
```typescript
interface CacheEntriesTable {
  sheet_name: string;    // Primary key: シート名
  data: string;          // キャッシュデータ（JSON文字列）
  ttl: number;           // TTL（秒単位）
  created_at: number;    // 作成日時（UNIX timestamp）
  updated_at: number;    // 更新日時（UNIX timestamp）
}
```

**インデックス:**
- PRIMARY KEY: sheet_name
- INDEX: updated_at（古いキャッシュの削除用）

#### 3. user_sessions テーブル

ユーザーセッションを管理。

**用途:**
- JWTトークンのセッション管理
- ログアウト時のトークン無効化
- セッション有効期限管理

**スキーマ:**
```typescript
interface UserSessionsTable {
  token_hash: string;    // Primary key: トークンのハッシュ値
  user_id: string;       // ユーザーID（_Usersシートのobject_id）
  expires_at: number;    // 有効期限（UNIX timestamp）
  created_at: number;    // 作成日時（UNIX timestamp）
}
```

**インデックス:**
- PRIMARY KEY: token_hash
- INDEX: user_id（ユーザー別セッション検索用）
- INDEX: expires_at（期限切れセッション削除用）

#### 4. rate_limits テーブル

APIレート制限を管理。

**用途:**
- クライアントIPごとのリクエスト数制限
- エンドポイント別のレート制限
- DDoS対策

**スキーマ:**
```typescript
interface RateLimitsTable {
  client_id: string;     // Part of composite primary key: クライアント識別子（IPアドレス等）
  endpoint: string;      // Part of composite primary key: エンドポイントパス
  count: number;         // リクエスト回数
  window_start: number;  // ウィンドウ開始時刻（UNIX timestamp）
}
```

**インデックス:**
- PRIMARY KEY: (client_id, endpoint)
- INDEX: window_start（古いレコード削除用）

## ディレクトリ構造

```
src/
├── db/
│   ├── schema.ts          # Drizzle ORM スキーマ定義
│   ├── client.ts          # データベースクライアント
│   ├── migrations/        # マイグレーションファイル
│   └── seed.ts           # 初期データシード（開発用）
├── types/
│   └── database.ts       # データベース型定義
```

## インターフェース設計

### 1. スキーマ定義 (src/db/schema.ts)

```typescript
// Drizzle ORM schema definitions for all tables

import { sqliteTable, text, integer, index, primaryKey } from 'drizzle-orm/sqlite-core';
import { sql } from 'drizzle-orm';

/**
 * Config table: System-wide configuration key-value store
 * Stores settings like Google Sheets ID, API configurations, etc.
 */
export const config = sqliteTable('config', {
  key: text('key').primaryKey(),
  value: text('value').notNull(),
  description: text('description'),
  updated_at: integer('updated_at', { mode: 'timestamp' })
    .notNull()
    .default(sql`(unixepoch())`),
});

/**
 * Cache entries table: Stores Google Sheets API response cache
 * Improves performance by reducing API calls
 */
export const cacheEntries = sqliteTable(
  'cache_entries',
  {
    sheet_name: text('sheet_name').primaryKey(),
    data: text('data').notNull(), // JSON string
    ttl: integer('ttl').notNull(), // seconds
    created_at: integer('created_at', { mode: 'timestamp' })
      .notNull()
      .default(sql`(unixepoch())`),
    updated_at: integer('updated_at', { mode: 'timestamp' })
      .notNull()
      .default(sql`(unixepoch())`),
  },
  (table) => ({
    updatedAtIdx: index('cache_entries_updated_at_idx').on(table.updated_at),
  })
);

/**
 * User sessions table: Manages JWT token sessions
 * Enables session invalidation on logout
 */
export const userSessions = sqliteTable(
  'user_sessions',
  {
    token_hash: text('token_hash').primaryKey(),
    user_id: text('user_id').notNull(),
    expires_at: integer('expires_at', { mode: 'timestamp' }).notNull(),
    created_at: integer('created_at', { mode: 'timestamp' })
      .notNull()
      .default(sql`(unixepoch())`),
  },
  (table) => ({
    userIdIdx: index('user_sessions_user_id_idx').on(table.user_id),
    expiresAtIdx: index('user_sessions_expires_at_idx').on(table.expires_at),
  })
);

/**
 * Rate limits table: Tracks API request rates per client and endpoint
 * Prevents abuse and implements rate limiting
 */
export const rateLimits = sqliteTable(
  'rate_limits',
  {
    client_id: text('client_id').notNull(),
    endpoint: text('endpoint').notNull(),
    count: integer('count').notNull().default(0),
    window_start: integer('window_start', { mode: 'timestamp' }).notNull(),
  },
  (table) => ({
    pk: primaryKey({ columns: [table.client_id, table.endpoint] }),
    windowStartIdx: index('rate_limits_window_start_idx').on(
      table.window_start
    ),
  })
);

// Export type helpers for TypeScript
export type Config = typeof config.$inferSelect;
export type NewConfig = typeof config.$inferInsert;
export type CacheEntry = typeof cacheEntries.$inferSelect;
export type NewCacheEntry = typeof cacheEntries.$inferInsert;
export type UserSession = typeof userSessions.$inferSelect;
export type NewUserSession = typeof userSessions.$inferInsert;
export type RateLimit = typeof rateLimits.$inferSelect;
export type NewRateLimit = typeof rateLimits.$inferInsert;
```

### 2. データベースクライアント (src/db/client.ts)

```typescript
// Database client for Cloudflare D1 with Drizzle ORM

import { drizzle } from 'drizzle-orm/d1';
import type { DrizzleD1Database } from 'drizzle-orm/d1';
import * as schema from './schema';
import type { Env } from '../types/env';

/**
 * Create database client instance
 * @param env - Cloudflare Workers environment bindings
 * @returns Configured Drizzle ORM client
 */
export function createDbClient(
  env: Env
): DrizzleD1Database<typeof schema> {
  // Initialize Drizzle ORM with D1 database binding
  return drizzle(env.DB, { schema });
}

/**
 * Database client type for use in application code
 */
export type DbClient = ReturnType<typeof createDbClient>;
```

### 3. 環境変数型定義更新 (src/types/env.ts)

```typescript
// Environment variables and bindings for Cloudflare Workers

import type { D1Database } from '@cloudflare/workers-types';

export interface Env {
  // Existing
  ENVIRONMENT: string;

  // D1 Database binding
  DB: D1Database;
}
```

## マイグレーション戦略

### Drizzle Kit設定

```typescript
// drizzle.config.ts

import type { Config } from 'drizzle-kit';

export default {
  schema: './src/db/schema.ts',
  out: './src/db/migrations',
  driver: 'd1',
  dbCredentials: {
    wranglerConfigPath: './wrangler.toml',
    dbName: 'sheet-db',
  },
} satisfies Config;
```

### マイグレーション手順

1. **スキーマ定義**: `src/db/schema.ts` にテーブル定義
2. **マイグレーション生成**: `npx drizzle-kit generate:sqlite`
3. **ローカル適用**: `wrangler d1 migrations apply sheet-db --local`
4. **本番適用**: `wrangler d1 migrations apply sheet-db --remote`

## wrangler.toml更新

```toml
# D1データベースバインディング追加

# 本番環境用
[[d1_databases]]
binding = "DB"
database_name = "sheet-db"
database_id = "" # 本番環境でwrangler d1 create実行後に設定

# 開発環境用
[env.dev]
[[env.dev.d1_databases]]
binding = "DB"
database_name = "sheet-db-dev"
database_id = "" # 開発環境でwrangler d1 create実行後に設定
```

## テスト戦略

### ユニットテスト

```typescript
// tests/unit/db/schema.test.ts

import { describe, it, expect } from 'vitest';
import { config, cacheEntries, userSessions, rateLimits } from '../../../src/db/schema';

describe('Database Schema', () => {
  it('should have config table with correct columns', () => {
    // Test schema structure
  });

  it('should have cache_entries table with correct columns', () => {
    // Test schema structure
  });

  it('should have user_sessions table with correct columns', () => {
    // Test schema structure
  });

  it('should have rate_limits table with correct columns', () => {
    // Test schema structure
  });
});
```

### 統合テスト

```typescript
// tests/integration/db/client.test.ts

import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { createDbClient } from '../../../src/db/client';

describe('Database Client', () => {
  // Test database connection
  // Test CRUD operations on all tables
  // Test transaction support
  // Test index usage
});
```

## 完了条件

- [x] Drizzle ORM設定完了
- [x] 全テーブルスキーマ定義（config, cache_entries, user_sessions, rate_limits）
- [x] マイグレーション作成
- [x] データベースクライアント実装
- [x] ユニットテスト・統合テスト実装
- [x] ローカル環境でマイグレーション実行・動作確認
- [x] 本番D1データベース作成
- [x] 本番環境でマイグレーション実行・動作確認
- [x] `npm run test` 全テストパス
- [x] TypeScript型チェックエラーなし

## 依存関係

- **前提**: Task 1.1（プロジェクト初期化）完了
- **次タスク**: Task 2.1（Google認証・シート選択機能）

## 推定時間

5時間

## 注意事項

### セキュリティ

- トークンハッシュはSHA-256などの安全なハッシュ関数を使用
- 機密情報（パスワード、トークン）は平文で保存しない
- SQLインジェクション対策：Drizzle ORMのパラメータ化クエリを使用

### パフォーマンス

- インデックスを適切に設定（検索頻度の高いカラム）
- 古いレコードの定期削除（期限切れセッション、キャッシュ）
- クエリのN+1問題に注意

### 運用

- マイグレーションは必ずバージョン管理
- 本番適用前にローカルで十分にテスト
- ロールバック手順を事前に確認

## 参考資料

- [Drizzle ORM Documentation](https://orm.drizzle.team/)
- [Cloudflare D1 Documentation](https://developers.cloudflare.com/d1/)
- [Drizzle Kit Migrations](https://orm.drizzle.team/kit-docs/overview)
