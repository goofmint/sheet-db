# Task 1.1: プロジェクト初期化・デプロイ環境構築

## 概要

プロジェクトの基盤となる開発環境とデプロイ環境を構築します。TypeScript + React + Vite + Hono + Cloudflare Workersをベースとした、モダンなフルスタック構成を準備します。

## 目標

- フロントエンド（React + Vite + TypeScript）とバックエンド（Hono + Cloudflare Workers）の開発環境を構築
- CI/CDパイプライン（GitHub Actions）を設定し、自動テスト・自動デプロイを実現
- テスト環境（Vitest + Playwright）を構築し、品質保証を確立
- 本番環境（Cloudflare Workers）へのデプロイを実施し、動作確認

## タスクチェックリスト

- [ ] package.json作成とTypeScript設定
- [ ] Vite + React + TypeScript 環境構築
- [ ] Hono + Cloudflare Workers 基本設定
- [ ] wrangler.toml 設定ファイル作成（本番・開発環境）
- [ ] ESLint, Prettier 設定
- [ ] Vitest テスト環境構築（実環境接続設定）
- [ ] Playwright テスト環境構築（Chrome使用、ブラウザテスト）
- [ ] GitHub Actions CI/CD設定（自動テスト・自動デプロイ）
- [ ] Cloudflare Workers本番環境設定
- [ ] 環境変数管理設定（開発・本番分離）
- [ ] 初回デプロイ実施・動作確認

## 技術スタック

### フロントエンド
- **ランタイム**: React 18
- **ビルドツール**: Vite
- **言語**: TypeScript 5
- **パッケージマネージャー**: npm

### バックエンド
- **フレームワーク**: Hono
- **ランタイム**: Cloudflare Workers
- **言語**: TypeScript 5

### テスト
- **ユニット/統合テスト**: Vitest
- **E2Eテスト**: Playwright（Chrome）

### CI/CD
- **プラットフォーム**: GitHub Actions
- **デプロイ先**: Cloudflare Workers

### コード品質
- **リンター**: ESLint
- **フォーマッター**: Prettier

## アーキテクチャ設計

### ディレクトリ構造

```
sheet-db/
├── src/
│   ├── client/              # フロントエンド
│   │   ├── components/      # Reactコンポーネント
│   │   ├── pages/           # ページコンポーネント
│   │   ├── hooks/           # カスタムフック
│   │   ├── stores/          # 状態管理（Zustand）
│   │   ├── services/        # APIクライアント
│   │   ├── types/           # 型定義
│   │   ├── utils/           # ユーティリティ
│   │   ├── App.tsx          # アプリケーションルート
│   │   └── main.tsx         # エントリーポイント
│   │
│   ├── server/              # バックエンド
│   │   ├── routes/          # APIルート
│   │   ├── services/        # ビジネスロジック
│   │   ├── middlewares/     # ミドルウェア
│   │   ├── types/           # 型定義
│   │   ├── utils/           # ユーティリティ
│   │   └── index.ts         # エントリーポイント
│   │
│   └── shared/              # 共有コード
│       ├── types/           # 共有型定義
│       └── constants/       # 定数
│
├── tests/
│   ├── unit/                # ユニットテスト
│   ├── integration/         # 統合テスト
│   └── e2e/                 # E2Eテスト（Playwright）
│
├── .github/
│   └── workflows/           # GitHub Actions
│
├── package.json
├── tsconfig.json
├── vite.config.ts
├── vitest.config.ts
├── playwright.config.ts
├── wrangler.toml
├── .eslintrc.json
└── .prettierrc.json
```

### インターフェース設計

#### 1. package.json

```typescript
interface PackageJson {
  name: string;
  version: string;
  type: "module";
  scripts: {
    // 開発
    "dev:client": string;  // "vite"
    "dev:server": string;  // "wrangler dev"
    "dev": string;         // "concurrently \"npm:dev:client\" \"npm:dev:server\""

    // ビルド
    "build:client": string; // "vite build"
    "build:server": string; // "tsc && esbuild src/server/index.ts --bundle --outfile=dist/worker.js"
    "build": string;        // "npm run build:client && npm run build:server"

    // テスト
    "test": string;         // "vitest"
    "test:ui": string;      // "vitest --ui"
    "test:e2e": string;     // "playwright test"

    // 品質チェック
    "lint": string;         // "eslint src --ext ts,tsx"
    "format": string;       // "prettier --write \"src/**/*.{ts,tsx}\""
    "typecheck": string;    // "tsc --noEmit"

    // デプロイ
    "deploy": string;       // "wrangler deploy"
  };
  dependencies: {
    // フロントエンド
    "react": string;
    "react-dom": string;
    "react-router-dom": string;
    "zustand": string;

    // バックエンド
    "hono": string;
  };
  devDependencies: {
    // TypeScript
    "@types/react": string;
    "@types/react-dom": string;
    "typescript": string;

    // Vite
    "vite": string;
    "@vitejs/plugin-react": string;

    // Cloudflare Workers
    "@cloudflare/workers-types": string;
    "wrangler": string;
    "esbuild": string;

    // テスト
    "vitest": string;
    "@vitest/ui": string;
    "@playwright/test": string;

    // 品質
    "eslint": string;
    "@typescript-eslint/parser": string;
    "@typescript-eslint/eslint-plugin": string;
    "prettier": string;

    // ユーティリティ
    "concurrently": string;
  };
}
```

#### 2. TypeScript設定

```typescript
// tsconfig.json
interface TSConfig {
  compilerOptions: {
    target: "ES2022";
    module: "ESNext";
    lib: ["ES2022", "DOM", "DOM.Iterable"];
    jsx: "react-jsx";
    moduleResolution: "bundler";
    resolveJsonModule: true;
    allowImportingTsExtensions: true;
    isolatedModules: true;
    noEmit: true;
    strict: true;
    skipLibCheck: true;
    esModuleInterop: true;
    forceConsistentCasingInFileNames: true;
    paths: {
      "@/*": ["./src/*"];
      "@client/*": ["./src/client/*"];
      "@server/*": ["./src/server/*"];
      "@shared/*": ["./src/shared/*"];
    };
  };
  include: ["src/**/*"];
  exclude: ["node_modules", "dist"];
}
```

#### 3. Vite設定

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

interface ViteConfig {
  plugins: any[];
  resolve: {
    alias: {
      '@': string;
      '@client': string;
      '@server': string;
      '@shared': string;
    };
  };
  server: {
    port: number;
    proxy: {
      '/api': {
        target: string;
        changeOrigin: boolean;
      };
    };
  };
  build: {
    outDir: string;
    sourcemap: boolean;
  };
}

// 実装例（説明のみ）：
// - React pluginを使用
// - パスエイリアス設定
// - APIプロキシ設定（開発時にWorkerへ転送）
// - ビルド設定
```

#### 4. Wrangler設定

```typescript
// wrangler.toml
interface WranglerConfig {
  name: string;
  main: string;           // "dist/worker.js"
  compatibility_date: string;

  // 環境変数（開発環境）
  vars: {
    ENVIRONMENT: "development";
  };

  // 本番環境設定
  env: {
    production: {
      name: string;
      vars: {
        ENVIRONMENT: "production";
      };
      // D1データベース、R2バケット等は後のタスクで追加
    };
  };
}

// 説明：
// - 開発環境と本番環境を分離
// - 環境変数で環境を判別
// - 今後のタスクでD1、R2等のバインディングを追加予定
```

#### 5. Vitest設定

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';

interface VitestConfig {
  test: {
    globals: boolean;
    environment: 'node';
    setupFiles: string[];
    coverage: {
      provider: 'v8';
      reporter: ['text', 'json', 'html'];
      exclude: string[];
    };
  };
}

// 説明：
// - グローバルテストAPI有効化
// - Node環境でテスト実行
// - カバレッジレポート設定
// - 実環境接続テスト用のセットアップファイル設定
```

#### 6. Playwright設定

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

interface PlaywrightConfig {
  testDir: string;
  fullyParallel: boolean;
  forbidOnly: boolean;
  retries: number;
  workers: number;
  reporter: string;
  use: {
    baseURL: string;
    trace: string;
    screenshot: string;
  };
  projects: Array<{
    name: string;
    use: { ...devices['Desktop Chrome'] };
  }>;
  webServer: {
    command: string;
    url: string;
    reuseExistingServer: boolean;
  };
}

// 説明：
// - Chromeでのテスト実行
// - 開発サーバー自動起動
// - トレース・スクリーンショット設定
// - 並列実行設定
```

#### 7. GitHub Actions CI/CD

```yaml
# .github/workflows/ci.yml
name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck
      - run: npm run test
      - run: npx playwright install --with-deps
      - run: npm run test:e2e

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run build
      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: deploy --env production
```

説明：
- PRとmainブランチへのpushでテスト実行
- Lint、型チェック、ユニットテスト、E2Eテストを順次実行
- mainブランチへのマージ時のみデプロイ
- Cloudflare API Tokenはシークレットで管理

#### 8. ESLint設定

```typescript
// .eslintrc.json
interface ESLintConfig {
  parser: "@typescript-eslint/parser";
  parserOptions: {
    ecmaVersion: "latest";
    sourceType: "module";
    ecmaFeatures: {
      jsx: true;
    };
  };
  extends: [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended"
  ];
  rules: {
    "@typescript-eslint/no-explicit-any": "error";
    "@typescript-eslint/no-unused-vars": "error";
    "react/react-in-jsx-scope": "off";
  };
}

// 説明：
// - TypeScriptとReactの推奨設定を適用
// - any型の使用を禁止
// - 未使用変数を検出
// - React 17+のJSX Transformに対応
```

#### 9. Prettier設定

```typescript
// .prettierrc.json
interface PrettierConfig {
  semi: true;
  trailingComma: "es5";
  singleQuote: true;
  printWidth: 80;
  tabWidth: 2;
  useTabs: false;
}

// 説明：
// - セミコロン必須
// - シングルクォート使用
// - 行幅80文字
// - インデント2スペース
```

#### 10. 環境変数管理

```typescript
// .env.development
interface DevelopmentEnv {
  VITE_API_URL: "http://localhost:8787";
}

// .env.production
interface ProductionEnv {
  VITE_API_URL: "https://api.your-domain.com";
}

// 説明：
// - Viteの環境変数プレフィックス（VITE_）使用
// - 開発環境と本番環境で異なるAPIエンドポイント設定
// - .envファイルは.gitignoreに追加
```

#### 11. 初期エントリーポイント

```typescript
// src/client/main.tsx
interface ClientEntry {
  // 説明：
  // - ReactアプリケーションをDOMにマウント
  // - StrictModeでレンダリング
  // - ルーター設定を含むAppコンポーネントをレンダリング
}

// src/client/App.tsx
interface AppComponent {
  // 説明：
  // - React Routerのセットアップ
  // - レイアウトコンポーネントの配置
  // - 基本的なルート定義（後のタスクで拡張）
}

// src/server/index.ts
interface ServerEntry {
  // 説明：
  // - Honoアプリケーション初期化
  // - CORSミドルウェア設定
  // - ヘルスチェックエンドポイント定義
  // - エクスポート: export default app
}
```

## 完了条件

1. **開発コマンド実行成功**
   - `npm run dev` でフロントエンド・バックエンドが起動
   - ブラウザでhttp://localhost:5173にアクセス可能
   - APIがhttp://localhost:8787で応答

2. **ビルド成功**
   - `npm run build` がエラーなく完了
   - `dist/`ディレクトリに成果物が生成

3. **テスト実行成功**
   - `npm run test` でVitestテストが実行
   - `npm run test:e2e` でPlaywrightテストが実行（Chrome）

4. **品質チェック成功**
   - `npm run lint` でエラーなし
   - `npm run typecheck` で型エラーなし

5. **本番環境デプロイ成功**
   - `npm run deploy` でCloudflare Workersへデプロイ
   - デプロイされたURLにアクセスして動作確認
   - ヘルスチェックエンドポイント（/api/health）が正常応答

6. **CI/CD動作確認**
   - GitHub Actionsでテストが自動実行
   - mainブランチへのマージで自動デプロイ

## 依存関係

なし（最初のタスク）

## 推定作業時間

6時間

## 注意事項

1. **モック禁止**: テスト含め、モックは使用しない
2. **フォールバック禁止**: エラー時は明確に失敗させる
3. **ファイル行数制限**: 各ファイル300行以内を厳守
4. **型安全性**: `any`型の使用は禁止
5. **環境変数**: シークレット情報は環境変数で管理し、コードにハードコーディングしない

## 次のタスク

Task 1.2: 基盤UI・API構築
