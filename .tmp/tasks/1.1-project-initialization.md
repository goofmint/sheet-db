# Task 1.1: プロジェクト初期化・デプロイ環境構築

## 概要

プロジェクトの基盤となる開発環境とデプロイ環境を構築します。TypeScript + React + Vite + Hono + Cloudflare Workersをベースとした、モダンなフルスタック構成を準備します。

## 目標

- Hono + React(JSX)の同居構成で開発環境を構築（同一プロセス・同一IPアドレス）
- CI/CDパイプライン（GitHub Actions）を設定し、自動テスト・自動デプロイを実現
- テスト環境（Vitest + Playwright）を構築し、品質保証を確立
- 本番環境（Cloudflare Workers）へのデプロイを実施し、動作確認

## アーキテクチャ方針

### Hono + React(JSX)同居構成

**フロントエンドとバックエンドが同一のHonoアプリケーション内で動作**します。

#### フロントエンド（React互換JSX）

`@hono/react-compat`を使用してHonoのJSXをReact互換にします。

```bash
npm install react@npm:@hono/react-compat react-dom@npm:@hono/react-compat
```

これにより `hono/jsx/dom` でReactフック（useState等）が使用可能になります。

```jsx
import { useState, startViewTransition } from 'hono/jsx'
import { css, Style } from 'hono/css'

export default function App() {
  const [count, setCount] = useState(0)
  return (
    <>
      <Style />
      <h1>管理画面</h1>
      <button onClick={() => setCount(count + 1)}>
        Count: {count}
      </button>
    </>
  )
}
```

#### バックエンド（API）

`/api` 以下でREST APIを提供します。同じHonoアプリケーション内で実装します。

```typescript
app.get('/api/health', (c) => {
  return c.json({ status: 'ok' })
})
```

#### ルーティング構成

```
/ → フロントエンド（React JSX）
/api/* → REST API
```

同一プロセス・同一IPアドレスでフロントエンドとAPIを提供するため、CORS設定不要です。

## タスクチェックリスト

- [ ] package.json作成とTypeScript設定
- [ ] Hono + React(JSX) 同居環境構築
- [ ] wrangler.toml 設定ファイル作成（本番・開発環境）
- [ ] ESLint, Prettier 設定
- [ ] Vitest テスト環境構築（実環境接続設定）
- [ ] Playwright テスト環境構築（Chrome使用、ブラウザテスト）
- [ ] GitHub Actions CI/CD設定（自動テスト・自動デプロイ）
- [ ] Cloudflare Workers本番環境設定
- [ ] 環境変数管理設定（開発・本番分離）
- [ ] 初回デプロイ実施・動作確認

## 技術スタック

### フロントエンド + バックエンド統合
- **フレームワーク**: Hono（フロントエンド・バックエンド統合）
- **JSX**: Hono JSX（React互換: @hono/react-compat）
- **ランタイム**: Cloudflare Workers
- **言語**: TypeScript 5
- **パッケージマネージャー**: npm

### テスト
- **ユニット/統合テスト**: Vitest
- **E2Eテスト**: Playwright（Chrome）

### CI/CD
- **プラットフォーム**: GitHub Actions
- **デプロイ先**: Cloudflare Workers

### コード品質
- **リンター**: ESLint
- **フォーマッター**: Prettier

## アーキテクチャ設計

### ディレクトリ構造

```
sheet-db/
├── src/
│   ├── components/          # UIコンポーネント（Hono JSX）
│   │   ├── layout/          # レイアウトコンポーネント
│   │   ├── pages/           # ページコンポーネント
│   │   └── ui/              # 共通UIコンポーネント
│   │
│   ├── routes/              # APIルート
│   │   ├── api/             # REST APIエンドポイント
│   │   └── pages.tsx        # フロントエンドルート
│   │
│   ├── services/            # ビジネスロジック
│   │   ├── sheets/          # Google Sheets連携
│   │   ├── auth/            # 認証サービス
│   │   └── cache/           # キャッシュサービス
│   │
│   ├── middlewares/         # ミドルウェア
│   │   ├── auth.ts          # 認証ミドルウェア
│   │   └── error.ts         # エラーハンドリング
│   │
│   ├── types/               # 型定義
│   │
│   ├── utils/               # ユーティリティ
│   │
│   └── index.ts             # エントリーポイント（Honoアプリ）
│
├── tests/
│   ├── unit/                # ユニットテスト
│   ├── integration/         # 統合テスト
│   └── e2e/                 # E2Eテスト（Playwright）
│
├── .github/
│   └── workflows/           # GitHub Actions
│
├── package.json
├── tsconfig.json
├── vitest.config.ts
├── playwright.config.ts
├── wrangler.toml
├── .eslintrc.json
└── .prettierrc.json
```

**重要**: ViteやReact Routerは使用しません。すべてHonoのルーティングで実装します。

### インターフェース設計

#### 1. package.json

```typescript
interface PackageJson {
  name: string;
  version: string;
  type: "module";
  scripts: {
    // 開発
    "dev": string;          // "wrangler dev"

    // ビルド
    "build": string;        // "tsc"

    // テスト
    "test": string;         // "vitest"
    "test:ui": string;      // "vitest --ui"
    "test:e2e": string;     // "playwright test"

    // 品質チェック
    "lint": string;         // "eslint src --ext ts,tsx"
    "format": string;       // "prettier --write \"src/**/*.{ts,tsx}\""
    "typecheck": string;    // "tsc --noEmit"

    // デプロイ
    "deploy": string;       // "wrangler deploy"
  };
  dependencies: {
    // Hono + React互換JSX
    "hono": string;
    "react": string;                    // npm:@hono/react-compat
    "react-dom": string;                // npm:@hono/react-compat
  };
  devDependencies: {
    // TypeScript
    "typescript": string;

    // Cloudflare Workers
    "@cloudflare/workers-types": string;
    "wrangler": string;

    // テスト
    "vitest": string;
    "@vitest/ui": string;
    "@playwright/test": string;

    // 品質
    "eslint": string;
    "@typescript-eslint/parser": string;
    "@typescript-eslint/eslint-plugin": string;
    "prettier": string;
  };
}
```

**説明**:
- ViteやReact Router等のフロントエンド専用ライブラリは不要
- react, react-domは`@hono/react-compat`のエイリアス
- ビルドはTypeScriptコンパイラのみ（wranglerが自動でバンドル）
- 開発・デプロイは全てwranglerで実行

#### 2. TypeScript設定

```typescript
// tsconfig.json
interface TSConfig {
  compilerOptions: {
    target: "ES2022";
    module: "ESNext";
    lib: ["ES2022"];
    jsx: "react-jsx";
    jsxImportSource: "hono/jsx";
    moduleResolution: "bundler";
    resolveJsonModule: true;
    allowImportingTsExtensions: true;
    isolatedModules: true;
    strict: true;
    skipLibCheck: true;
    esModuleInterop: true;
    forceConsistentCasingInFileNames: true;
    types: ["@cloudflare/workers-types"];
    paths: {
      "react": ["./node_modules/@hono/react-compat"];
      "react-dom": ["./node_modules/@hono/react-compat"];
    };
  };
  include: ["src/**/*"];
  exclude: ["node_modules", "dist"];
}
```

**説明**:
- `jsx: "react-jsx"` + `jsxImportSource: "hono/jsx"`: Hono JSX使用
- DOM関連のlibは不要（Cloudflare Workers環境）
- react, react-domのパスエイリアスで@hono/react-compatを参照

#### 3. Wrangler設定

```typescript
// wrangler.toml
interface WranglerConfig {
  name: string;
  main: string;           // "src/index.ts"
  compatibility_date: string;

  // 環境変数（開発環境）
  vars: {
    ENVIRONMENT: "development";
  };

  // 本番環境設定
  env: {
    production: {
      name: string;
      vars: {
        ENVIRONMENT: "production";
      };
      // D1データベース、R2バケット等は後のタスクで追加
    };
  };
}
```

**説明**:
- mainは`src/index.ts`を直接指定（wranglerが自動でバンドル）
- 開発環境と本番環境を分離
- 今後のタスクでD1、R2等のバインディングを追加予定

#### 4. Vitest設定

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';

interface VitestConfig {
  test: {
    globals: boolean;
    environment: 'node';
    setupFiles: string[];
    coverage: {
      provider: 'v8';
      reporter: ['text', 'json', 'html'];
      exclude: string[];
    };
  };
}

// 説明：
// - グローバルテストAPI有効化
// - Node環境でテスト実行
// - カバレッジレポート設定
// - 実環境接続テスト用のセットアップファイル設定
```

#### 5. Playwright設定

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

interface PlaywrightConfig {
  testDir: string;
  fullyParallel: boolean;
  forbidOnly: boolean;
  retries: number;
  workers: number;
  reporter: string;
  use: {
    baseURL: string;
    trace: string;
    screenshot: string;
  };
  projects: Array<{
    name: string;
    use: { ...devices['Desktop Chrome'] };
  }>;
  webServer: {
    command: string;
    url: string;
    reuseExistingServer: boolean;
  };
}

// 説明：
// - Chromeでのテスト実行
// - 開発サーバー自動起動
// - トレース・スクリーンショット設定
// - 並列実行設定
```

#### 6. GitHub Actions CI/CD

```yaml
# .github/workflows/ci.yml
name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck
      - run: npm run test
      - run: npx playwright install --with-deps
      - run: npm run test:e2e

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run build
      - uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          command: deploy --env production
```

説明：
- PRとmainブランチへのpushでテスト実行
- Lint、型チェック、ユニットテスト、E2Eテストを順次実行
- mainブランチへのマージ時のみデプロイ
- Cloudflare API Tokenはシークレットで管理

#### 7. ESLint設定

```typescript
// .eslintrc.json
interface ESLintConfig {
  parser: "@typescript-eslint/parser";
  parserOptions: {
    ecmaVersion: "latest";
    sourceType: "module";
    ecmaFeatures: {
      jsx: true;
    };
  };
  extends: [
    "eslint:recommended",
    "plugin:@typescript-eslint/recommended",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended"
  ];
  rules: {
    "@typescript-eslint/no-explicit-any": "error";
    "@typescript-eslint/no-unused-vars": "error";
    "react/react-in-jsx-scope": "off";
  };
}

// 説明：
// - TypeScriptとReactの推奨設定を適用
// - any型の使用を禁止
// - 未使用変数を検出
// - React 17+のJSX Transformに対応
```

#### 8. Prettier設定

```typescript
// .prettierrc.json
interface PrettierConfig {
  semi: true;
  trailingComma: "es5";
  singleQuote: true;
  printWidth: 80;
  tabWidth: 2;
  useTabs: false;
}

// 説明：
// - セミコロン必須
// - シングルクォート使用
// - 行幅80文字
// - インデント2スペース
```

#### 9. 初期エントリーポイント

```typescript
// src/index.ts
interface MainEntry {
  // 説明：
  // - Honoアプリケーション初期化
  // - フロントエンドルート登録（/）
  // - APIルート登録（/api/*）
  // - エラーハンドリングミドルウェア設定
  // - エクスポート: export default app
}

// src/routes/pages.tsx
interface PagesRoute {
  // 説明：
  // - Hono JSXでフロントエンドページを返す
  // - / → 管理画面（Hono JSXコンポーネント）
  // - HTMLテンプレート + クライアントサイドスクリプト
}

// src/routes/api/health.ts
interface HealthAPI {
  // 説明：
  // - ヘルスチェックエンドポイント
  // - GET /api/health → { status: "ok" }
}

// src/components/pages/Dashboard.tsx
interface DashboardComponent {
  // 説明：
  // - Hono JSXで実装された管理画面トップページ
  // - useState等のReactフックが使用可能
  // - hono/cssでスタイリング
}
```

## 完了条件

1. **開発コマンド実行成功**
   - `npm run dev` でHonoアプリケーションが起動
   - ブラウザでhttp://localhost:8787にアクセス可能
   - 管理画面（/）が表示される
   - APIエンドポイント（/api/health）が応答

2. **ビルド成功**
   - `npm run build` がエラーなく完了（TypeScriptコンパイル）

3. **テスト実行成功**
   - `npm run test` でVitestテストが実行
   - `npm run test:e2e` でPlaywrightテストが実行（Chrome）

4. **品質チェック成功**
   - `npm run lint` でエラーなし
   - `npm run typecheck` で型エラーなし

5. **本番環境デプロイ成功**
   - `npm run deploy` でCloudflare Workersへデプロイ
   - デプロイされたURLにアクセスして動作確認
   - 管理画面（/）が表示される
   - ヘルスチェックエンドポイント（/api/health）が正常応答

6. **CI/CD動作確認**
   - GitHub Actionsでテストが自動実行
   - mainブランチへのマージで自動デプロイ

## 依存関係

なし（最初のタスク）

## 推定作業時間

6時間

## 注意事項

1. **モック禁止**: テスト含め、モックは使用しない
2. **フォールバック禁止**: エラー時は明確に失敗させる
3. **ファイル行数制限**: 各ファイル300行以内を厳守
4. **型安全性**: `any`型の使用は禁止
5. **環境変数**: シークレット情報は環境変数で管理し、コードにハードコーディングしない

## 次のタスク

Task 1.2: 基盤UI・API構築
