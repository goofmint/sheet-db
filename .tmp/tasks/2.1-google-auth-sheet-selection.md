# Task 2.1: Google認証・シート選択機能実装

**タスクID**: 2.1
**タスク名**: Google認証・シート選択機能実装
**依存**: Task 1.3 (D1データベース基盤)
**推定時間**: 9時間

## 概要

初期設定画面でGoogle OAuth2認証を実装し、ユーザーがGoogle Sheetsを選択できる機能を提供します。選択されたシート情報はD1のconfigテーブルに保存されます。

## 技術スタック

- **認証**: Google OAuth 2.0
- **UI**: Hono JSX (SSR)
- **API**: Hono (Cloudflare Workers)
- **データベース**: D1 (Drizzle ORM)
- **Google API**: googleapis (Google Sheets API v4)

## 実装範囲

### 1. Google OAuth2設定

#### 環境変数設定
```typescript
// wrangler.toml への追加
[vars]
GOOGLE_CLIENT_ID = "開発環境用クライアントID"
GOOGLE_REDIRECT_URI = "http://localhost:8787/api/setup/google-callback"

// 本番環境用はCloudflare Dashboardで設定
```

#### Secretsの管理
```bash
# 開発環境
wrangler secret put GOOGLE_CLIENT_SECRET

# 本番環境
wrangler secret put GOOGLE_CLIENT_SECRET --env production
```

### 2. 初期設定画面UI実装

#### コンポーネント構造
```typescript
// src/components/Setup.tsx
/**
 * Initial setup page component
 *
 * Features:
 * - Google OAuth2 authentication flow
 * - Sheet selection UI
 * - Configuration save
 */
export const Setup: FC = () => {
  // Implementation: Initial setup page with Google auth button
};
```

#### 画面構成
- Google認証ボタン
- 認証状態表示
- シート選択ドロップダウン（認証後に表示）
- 設定保存ボタン
- 進行状況インジケーター

### 3. シート選択UI実装

```typescript
// src/components/SheetSelector.tsx
/**
 * Sheet selector component
 *
 * Features:
 * - Display available sheets from authenticated Google account
 * - Sheet selection dropdown
 * - Sheet preview (first few rows)
 */
interface SheetSelectorProps {
  sheets: Sheet[];
  onSelect: (sheetId: string) => void;
  selectedSheetId?: string;
}

export const SheetSelector: FC<SheetSelectorProps> = (props) => {
  // Implementation: Sheet selection UI with preview
};
```

### 4. Google認証エンドポイント

```typescript
// src/routes/setup.ts
import { Hono } from 'hono';
import type { Env } from '../types/env';

const setup = new Hono<{ Bindings: Env }>();

/**
 * GET /api/setup/google-auth - Initiate Google OAuth2 flow
 *
 * Returns authorization URL for Google OAuth2
 */
setup.get('/google-auth', (c) => {
  // Implementation:
  // 1. Generate OAuth2 state token
  // 2. Build authorization URL with required scopes
  // 3. Return redirect URL to client
});

/**
 * GET /api/setup/google-callback - Handle OAuth2 callback
 *
 * Receives authorization code from Google
 * Exchanges code for access token and refresh token
 */
setup.get('/google-callback', async (c) => {
  // Implementation:
  // 1. Validate state token
  // 2. Exchange authorization code for tokens
  // 3. Store tokens in D1 config table
  // 4. Redirect to setup page with success status
});

export default setup;
```

### 5. シート一覧取得エンドポイント

```typescript
/**
 * GET /api/setup/sheets - Get available sheets
 *
 * Returns list of accessible Google Sheets from authenticated account
 */
setup.get('/sheets', async (c) => {
  // Implementation:
  // 1. Retrieve access token from config table
  // 2. Call Google Drive API to list spreadsheets
  // 3. Return sheet metadata (id, name, url)
});
```

### 6. シート選択エンドポイント

```typescript
/**
 * POST /api/setup/select-sheet - Select and configure a sheet
 *
 * Request body:
 * {
 *   "sheetId": "spreadsheet_id",
 *   "sheetName": "Sheet名"
 * }
 *
 * Saves selected sheet configuration to D1
 */
setup.post('/select-sheet', async (c) => {
  // Implementation:
  // 1. Validate sheet ID
  // 2. Fetch sheet metadata from Google Sheets API
  // 3. Validate sheet structure (_Users, _Roles tables)
  // 4. Save configuration to config table
  // 5. Return success response
});
```

### 7. Google API クライアント設定

```typescript
// src/services/google-auth.service.ts
import { google } from 'googleapis';
import type { Env } from '../types/env';

/**
 * Google OAuth2 Service
 *
 * Handles authentication and token management
 */
export class GoogleAuthService {
  private oauth2Client;

  constructor(env: Env) {
    // Implementation: Initialize OAuth2 client
  }

  /**
   * Generate authorization URL
   */
  async getAuthUrl(): Promise<string> {
    // Implementation: Build OAuth2 authorization URL
  }

  /**
   * Exchange authorization code for tokens
   */
  async getTokens(code: string): Promise<TokenResponse> {
    // Implementation: Exchange code for access/refresh tokens
  }

  /**
   * Refresh access token
   */
  async refreshAccessToken(refreshToken: string): Promise<string> {
    // Implementation: Refresh expired access token
  }
}
```

```typescript
// src/services/google-sheets.service.ts
import { google } from 'googleapis';

/**
 * Google Sheets Service
 *
 * Handles Google Sheets API operations
 */
export class GoogleSheetsService {
  private sheets;

  constructor(accessToken: string) {
    // Implementation: Initialize Sheets API client
  }

  /**
   * List available spreadsheets
   */
  async listSpreadsheets(): Promise<SpreadsheetMetadata[]> {
    // Implementation: List spreadsheets from Google Drive
  }

  /**
   * Get spreadsheet metadata
   */
  async getSpreadsheetMetadata(sheetId: string): Promise<SpreadsheetInfo> {
    // Implementation: Fetch sheet structure and properties
  }

  /**
   * Validate sheet structure
   */
  async validateSheetStructure(sheetId: string): Promise<ValidationResult> {
    // Implementation:
    // Check for required sheets: _Users, _Roles
    // Validate column structure
  }
}
```

### 8. 設定保存機能（D1 configテーブル）

```typescript
// src/db/config.repository.ts
import { createDbClient } from './client';
import { config } from './schema';
import type { Env } from '../types/env';

/**
 * Configuration Repository
 *
 * Manages system configuration in D1 config table
 */
export class ConfigRepository {
  private db;

  constructor(env: Env) {
    this.db = createDbClient(env);
  }

  /**
   * Save Google OAuth tokens
   */
  async saveGoogleTokens(tokens: {
    accessToken: string;
    refreshToken: string;
    expiresAt: Date;
  }): Promise<void> {
    // Implementation:
    // INSERT or UPDATE config entries
    // - google_access_token
    // - google_refresh_token
    // - google_token_expires_at
  }

  /**
   * Save selected sheet configuration
   */
  async saveSheetConfig(sheetConfig: {
    sheetId: string;
    sheetName: string;
    sheetUrl: string;
  }): Promise<void> {
    // Implementation:
    // INSERT or UPDATE config entries
    // - selected_sheet_id
    // - selected_sheet_name
    // - selected_sheet_url
  }

  /**
   * Get Google access token
   */
  async getGoogleAccessToken(): Promise<string | null> {
    // Implementation: Retrieve access token from config
  }

  /**
   * Check if initial setup is complete
   */
  async isSetupComplete(): Promise<boolean> {
    // Implementation:
    // Check if google_access_token and selected_sheet_id exist
  }
}
```

### 9. 型定義

```typescript
// src/types/google.ts

/**
 * Google OAuth2 token response
 */
export interface TokenResponse {
  access_token: string;
  refresh_token: string;
  expires_in: number;
  token_type: string;
  scope: string;
}

/**
 * Spreadsheet metadata
 */
export interface SpreadsheetMetadata {
  id: string;
  name: string;
  url: string;
  createdTime: string;
  modifiedTime: string;
}

/**
 * Spreadsheet detailed information
 */
export interface SpreadsheetInfo {
  id: string;
  name: string;
  sheets: SheetInfo[];
}

/**
 * Individual sheet information
 */
export interface SheetInfo {
  sheetId: number;
  title: string;
  index: number;
  rowCount: number;
  columnCount: number;
}

/**
 * Sheet structure validation result
 */
export interface ValidationResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
  hasUsersSheet: boolean;
  hasRolesSheet: boolean;
}
```

## セキュリティ要件

### OAuth2セキュリティ
1. **State Parameter**: CSRF攻撃防止のためstate tokenを使用
2. **PKCE**: 可能であればPKCE (Proof Key for Code Exchange) を実装
3. **Token Storage**: Refresh tokenは暗号化してD1に保存
4. **Scope Minimization**: 必要最小限のスコープのみ要求
   - `https://www.googleapis.com/auth/spreadsheets`
   - `https://www.googleapis.com/auth/drive.readonly`

### API Security
1. **Rate Limiting**: 認証エンドポイントにレート制限適用
2. **Input Validation**: すべてのユーザー入力を検証
3. **Error Handling**: 詳細なエラー情報を外部に漏らさない

## エラーハンドリング

### 認証エラー
- OAuth2認証失敗時の明確なエラーメッセージ
- トークン期限切れ時の自動リフレッシュ
- リフレッシュトークン無効時の再認証フロー

### シート選択エラー
- シートアクセス権限不足
- 必須シート(_Users, _Roles)の欠落
- シート構造の不正

### データベースエラー
- 設定保存失敗時のロールバック
- 接続エラー時のリトライ

## テスト要件

### 統合テスト
```typescript
// tests/integration/setup/google-auth.test.ts
describe('Google OAuth2 Integration', () => {
  it('should generate valid authorization URL', async () => {
    // Implementation: Test authorization URL generation
  });

  it('should exchange code for tokens', async () => {
    // Implementation: Test token exchange (with real Google API)
  });

  it('should save tokens to config table', async () => {
    // Implementation: Test token persistence
  });
});
```

### E2Eテスト (Playwright)
```typescript
// tests/e2e/setup/initial-setup.spec.ts
test('complete initial setup flow', async ({ page }) => {
  // Implementation:
  // 1. Navigate to /setup
  // 2. Click "Connect Google Account"
  // 3. Complete Google OAuth flow
  // 4. Select a sheet
  // 5. Save configuration
  // 6. Verify redirect to dashboard
});
```

## 完了条件

1. ✅ 初期設定画面が表示される
2. ✅ Google認証ボタンがクリック可能
3. ✅ Google OAuth2フローが正常に完了
4. ✅ 認証後、利用可能なシート一覧が表示される
5. ✅ シートを選択して保存できる
6. ✅ 設定がD1 configテーブルに保存される
7. ✅ 画面での初期設定が実環境で完全動作
8. ✅ 本番環境にデプロイして動作確認

## 依存パッケージ

```json
{
  "dependencies": {
    "googleapis": "^140.0.0"
  }
}
```

## 環境設定チェックリスト

- [ ] Google Cloud Console プロジェクト作成
- [ ] OAuth 2.0 クライアント ID 作成（開発環境）
- [ ] OAuth 2.0 クライアント ID 作成（本番環境）
- [ ] 承認済みリダイレクトURI 設定
- [ ] Google Sheets API 有効化
- [ ] Google Drive API 有効化
- [ ] Cloudflare Secrets設定 (GOOGLE_CLIENT_SECRET)

## 参考リソース

- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [Google Sheets API v4](https://developers.google.com/sheets/api)
- [googleapis Node.js Client](https://github.com/googleapis/google-api-nodejs-client)
