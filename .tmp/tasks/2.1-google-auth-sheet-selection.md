# Task 2.1: Google認証・シート選択機能実装

**タスクID**: 2.1
**タスク名**: Google認証・シート選択機能実装
**依存**: Task 1.3 (D1データベース基盤)
**推定時間**: 9時間

## 概要

初期設定画面でGoogle OAuth2認証を実装し、ユーザーがGoogle Sheetsを選択できる機能を提供します。Google認証情報（Client ID、Client Secret、Redirect URI）はフォーム入力で設定し、選択されたシート情報と共にD1のconfigテーブルに保存されます。

## 技術スタック

- **認証**: Google OAuth 2.0
- **UI**: Hono JSX (SSR)
- **API**: Hono (Cloudflare Workers)
- **データベース**: D1 (Drizzle ORM)
- **設定管理**: D1 configテーブル（Google認証情報含む）

## 実装範囲

### 1. Google OAuth2設定フォーム

#### 設定入力UI
```typescript
// Google認証情報入力フォーム
interface GoogleAuthConfig {
  clientId: string;        // Google Cloud ConsoleのOAuth 2.0クライアントID
  clientSecret: string;    // クライアントシークレット
  redirectUri: string;     // リダイレクトURI (例: https://your-app.workers.dev/api/setup/google-callback)
}
```

**入力項目:**
1. **Google Client ID** - OAuth 2.0クライアントID
2. **Google Client Secret** - クライアントシークレット（暗号化して保存）
3. **Redirect URI** - OAuth認証後のリダイレクト先（自動生成も可能）

**保存先:**
- D1 configテーブルの以下のキー
  - `google_client_id`
  - `google_client_secret` (暗号化)
  - `google_redirect_uri`

### 2. 初期設定画面UI実装

#### コンポーネント構造
```typescript
// src/components/Setup.tsx
/**
 * Initial setup page component
 *
 * Setup Flow:
 * 1. Google認証情報入力フォーム (Client ID, Secret, Redirect URI)
 * 2. 認証情報保存
 * 3. Google OAuth2認証フロー開始
 * 4. シート選択
 * 5. 設定完了
 */
export const Setup: FC = () => {
  // Implementation: Multi-step setup wizard
};
```

#### 画面構成（ステップバイステップ）

**Step 1: Google認証情報設定**
- Google Client ID 入力フィールド
- Google Client Secret 入力フィールド（password type）
- Redirect URI 入力フィールド（デフォルト値自動設定可能）
- 「認証情報を保存」ボタン
- Google Cloud Consoleへのリンク（設定方法ガイド）

**Step 2: Google認証**
- 「Googleアカウントに接続」ボタン（Step 1完了後に有効化）
- 認証状態表示

**Step 3: シート選択**
- シート選択ドロップダウン（認証後に表示）
- シートプレビュー（オプション）
- 「設定を完了」ボタン

**共通要素**
- 進行状況インジケーター（Step 1/3, 2/3, 3/3）
- エラーメッセージ表示エリア

### 3. シート選択UI実装

```typescript
// src/components/SheetSelector.tsx
/**
 * Sheet selector component
 *
 * Features:
 * - Display available sheets from authenticated Google account
 * - Sheet selection dropdown
 * - Sheet preview (first few rows)
 */
interface SheetSelectorProps {
  sheets: Sheet[];
  onSelect: (sheetId: string) => void;
  selectedSheetId?: string;
}

export const SheetSelector: FC<SheetSelectorProps> = (props) => {
  // Implementation: Sheet selection UI with preview
};
```

### 4. Google認証情報保存エンドポイント

```typescript
// src/routes/setup.ts
import { Hono } from 'hono';
import type { Env } from '../types/env';

const setup = new Hono<{ Bindings: Env }>();

/**
 * POST /api/setup/google-config - Save Google OAuth2 credentials
 *
 * Request body:
 * {
 *   "clientId": "xxx.apps.googleusercontent.com",
 *   "clientSecret": "GOCSPX-xxx",
 *   "redirectUri": "https://your-app.workers.dev/api/setup/google-callback"
 * }
 *
 * Saves Google OAuth2 credentials to D1 config table
 */
setup.post('/google-config', async (c) => {
  // Implementation:
  // 1. Validate input (required fields, format)
  // 2. Encrypt client secret
  // 3. Save to config table:
  //    - google_client_id
  //    - google_client_secret (encrypted)
  //    - google_redirect_uri
  // 4. Return success response
});

/**
 * GET /api/setup/google-auth - Initiate Google OAuth2 flow
 *
 * Returns authorization URL for Google OAuth2
 * Requires google_client_id to be configured in config table
 */
setup.get('/google-auth', async (c) => {
  // Implementation:
  // 1. Retrieve google_client_id from config table
  // 2. Generate OAuth2 state token
  // 3. Build authorization URL with required scopes
  // 4. Return redirect URL to client
});

/**
 * GET /api/setup/google-callback - Handle OAuth2 callback
 *
 * Receives authorization code from Google
 * Exchanges code for access token and refresh token
 */
setup.get('/google-callback', async (c) => {
  // Implementation:
  // 1. Retrieve google_client_id, google_client_secret from config table
  // 2. Validate state token
  // 3. Exchange authorization code for tokens
  // 4. Store tokens in D1 config table (google_access_token, google_refresh_token)
  // 5. Redirect to setup page with success status
});

export default setup;
```

### 5. シート一覧取得エンドポイント

```typescript
/**
 * GET /api/setup/sheets - Get available sheets
 *
 * Returns list of accessible Google Sheets from authenticated account
 */
setup.get('/sheets', async (c) => {
  // Implementation:
  // 1. Retrieve access token from config table
  // 2. Call Google Drive API to list spreadsheets
  // 3. Return sheet metadata (id, name, url)
});
```

### 6. シート選択エンドポイント

```typescript
/**
 * POST /api/setup/select-sheet - Select and configure a sheet
 *
 * Request body:
 * {
 *   "sheetId": "spreadsheet_id",
 *   "sheetName": "Sheet名"
 * }
 *
 * Saves selected sheet configuration to D1
 */
setup.post('/select-sheet', async (c) => {
  // Implementation:
  // 1. Validate sheet ID
  // 2. Fetch sheet metadata from Google Sheets API
  // 3. Validate sheet structure (_Users, _Roles tables)
  // 4. Save configuration to config table
  // 5. Return success response
});
```

### 7. Google API クライアント設定

```typescript
// src/services/google-auth.service.ts
import type { Env } from '../types/env';
import type { TokenResponse } from '../types/google';
import { ConfigRepository } from '../db/config.repository';

/**
 * Google OAuth2 Service
 *
 * Handles authentication and token management using fetch-based REST API
 * Compatible with Cloudflare Workers runtime
 *
 * Credentials are stored in D1 config table, not environment variables
 *
 * Required OAuth Scopes:
 * - https://www.googleapis.com/auth/spreadsheets.readonly
 * - https://www.googleapis.com/auth/drive.readonly
 */
export class GoogleAuthService {
  private configRepo: ConfigRepository;

  constructor(env: Env) {
    // Implementation:
    // Initialize config repository to retrieve credentials from D1
    // this.configRepo = new ConfigRepository(env);
  }

  /**
   * Get Google credentials from config table
   */
  private async getCredentials(): Promise<{
    clientId: string;
    clientSecret: string;
    redirectUri: string;
  }> {
    // Implementation:
    // const clientId = await this.configRepo.get('google_client_id');
    // const clientSecret = await this.configRepo.getDecrypted('google_client_secret');
    // const redirectUri = await this.configRepo.get('google_redirect_uri');
    //
    // if (!clientId || !clientSecret || !redirectUri) {
    //   throw new Error('Google credentials not configured');
    // }
    //
    // return { clientId, clientSecret, redirectUri };
  }

  /**
   * Generate authorization URL
   *
   * Builds OAuth2 authorization URL with required scopes
   * Retrieves credentials from config table
   */
  async getAuthUrl(state: string): Promise<string> {
    // Implementation:
    // const { clientId, redirectUri } = await this.getCredentials();
    //
    // const params = new URLSearchParams({
    //   client_id: clientId,
    //   redirect_uri: redirectUri,
    //   response_type: 'code',
    //   scope: 'https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/drive.readonly',
    //   access_type: 'offline',
    //   prompt: 'consent',
    //   state: state
    // });
    // return `https://accounts.google.com/o/oauth2/v2/auth?${params}`;
  }

  /**
   * Exchange authorization code for tokens
   *
   * Uses Google OAuth2 token endpoint via fetch
   * Retrieves credentials from config table
   */
  async getTokens(code: string): Promise<TokenResponse> {
    // Implementation:
    // const { clientId, clientSecret, redirectUri } = await this.getCredentials();
    //
    // const response = await fetch('https://oauth2.googleapis.com/token', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    //   body: new URLSearchParams({
    //     code,
    //     client_id: clientId,
    //     client_secret: clientSecret,
    //     redirect_uri: redirectUri,
    //     grant_type: 'authorization_code'
    //   })
    // });
    //
    // if (!response.ok) {
    //   throw new Error(`Token exchange failed: ${response.statusText}`);
    // }
    //
    // return await response.json();
  }

  /**
   * Refresh access token
   *
   * Uses Google OAuth2 token endpoint to refresh expired token
   * Retrieves credentials from config table
   */
  async refreshAccessToken(refreshToken: string): Promise<string> {
    // Implementation:
    // const { clientId, clientSecret } = await this.getCredentials();
    //
    // const response = await fetch('https://oauth2.googleapis.com/token', {
    //   method: 'POST',
    //   headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    //   body: new URLSearchParams({
    //     refresh_token: refreshToken,
    //     client_id: clientId,
    //     client_secret: clientSecret,
    //     grant_type: 'refresh_token'
    //   })
    // });
    //
    // if (!response.ok) {
    //   throw new Error(`Token refresh failed: ${response.statusText}`);
    // }
    //
    // const data = await response.json();
    // return data.access_token;
  }
}
```

```typescript
// src/services/google-sheets.service.ts
import type { SpreadsheetMetadata, SpreadsheetInfo, ValidationResult } from '../types/google';

/**
 * Google Sheets Service
 *
 * Handles Google Sheets API operations using fetch-based REST API
 * Compatible with Cloudflare Workers runtime
 *
 * Uses Google Drive API v3 and Google Sheets API v4
 */
export class GoogleSheetsService {
  private accessToken: string;

  constructor(accessToken: string) {
    // Implementation: Store access token for Authorization header
    // this.accessToken = accessToken;
  }

  /**
   * List available spreadsheets
   *
   * Calls Google Drive API v3 files endpoint
   * Filters by mimeType for Google Sheets
   */
  async listSpreadsheets(): Promise<SpreadsheetMetadata[]> {
    // Implementation:
    // const params = new URLSearchParams({
    //   q: "mimeType='application/vnd.google-apps.spreadsheet'",
    //   fields: 'files(id,name,webViewLink,createdTime,modifiedTime)',
    //   orderBy: 'modifiedTime desc',
    //   pageSize: '100'
    // });
    //
    // const response = await fetch(
    //   `https://www.googleapis.com/drive/v3/files?${params}`,
    //   {
    //     headers: {
    //       'Authorization': `Bearer ${this.accessToken}`,
    //       'Accept': 'application/json'
    //     }
    //   }
    // );
    //
    // if (!response.ok) {
    //   throw new Error(`Failed to list spreadsheets: ${response.statusText}`);
    // }
    //
    // const data = await response.json();
    // return data.files.map(file => ({
    //   id: file.id,
    //   name: file.name,
    //   url: file.webViewLink,
    //   createdTime: file.createdTime,
    //   modifiedTime: file.modifiedTime
    // }));
  }

  /**
   * Get spreadsheet metadata
   *
   * Calls Google Sheets API v4 spreadsheets.get endpoint
   * Includes sheet properties (title, index, rowCount, columnCount)
   */
  async getSpreadsheetMetadata(sheetId: string): Promise<SpreadsheetInfo> {
    // Implementation:
    // const params = new URLSearchParams({
    //   fields: 'spreadsheetId,properties.title,sheets(properties(sheetId,title,index,gridProperties))'
    // });
    //
    // const response = await fetch(
    //   `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}?${params}`,
    //   {
    //     headers: {
    //       'Authorization': `Bearer ${this.accessToken}`,
    //       'Accept': 'application/json'
    //     }
    //   }
    // );
    //
    // if (!response.ok) {
    //   throw new Error(`Failed to get spreadsheet metadata: ${response.statusText}`);
    // }
    //
    // const data = await response.json();
    // return {
    //   id: data.spreadsheetId,
    //   name: data.properties.title,
    //   sheets: data.sheets.map(sheet => ({
    //     sheetId: sheet.properties.sheetId,
    //     title: sheet.properties.title,
    //     index: sheet.properties.index,
    //     rowCount: sheet.properties.gridProperties.rowCount,
    //     columnCount: sheet.properties.gridProperties.columnCount
    //   }))
    // };
  }

  /**
   * Validate sheet structure
   *
   * Checks for required sheets (_Users, _Roles) and validates column structure
   * Fetches first row to verify column headers
   */
  async validateSheetStructure(sheetId: string): Promise<ValidationResult> {
    // Implementation:
    // 1. Get spreadsheet metadata
    // const metadata = await this.getSpreadsheetMetadata(sheetId);
    //
    // 2. Check for _Users sheet
    // const usersSheet = metadata.sheets.find(s => s.title === '_Users');
    // const rolesSheet = metadata.sheets.find(s => s.title === '_Roles');
    //
    // const errors: string[] = [];
    // const warnings: string[] = [];
    //
    // if (!usersSheet) {
    //   errors.push('Required sheet "_Users" not found');
    // }
    // if (!rolesSheet) {
    //   errors.push('Required sheet "_Roles" not found');
    // }
    //
    // 3. Validate _Users columns (if exists)
    // if (usersSheet) {
    //   const response = await fetch(
    //     `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/_Users!A1:Z1`,
    //     {
    //       headers: {
    //         'Authorization': `Bearer ${this.accessToken}`,
    //         'Accept': 'application/json'
    //       }
    //     }
    //   );
    //   const data = await response.json();
    //   const columns = data.values?.[0] || [];
    //
    //   // Check for required columns
    //   const requiredColumns = ['id', 'email', 'name', 'role'];
    //   for (const col of requiredColumns) {
    //     if (!columns.includes(col)) {
    //       errors.push(`_Users sheet missing required column: ${col}`);
    //     }
    //   }
    // }
    //
    // 4. Validate _Roles columns (if exists)
    // Similar validation for _Roles sheet
    //
    // return {
    //   valid: errors.length === 0,
    //   errors,
    //   warnings,
    //   hasUsersSheet: !!usersSheet,
    //   hasRolesSheet: !!rolesSheet
    // };
  }
}
```

### 8. 設定保存機能（D1 configテーブル）

```typescript
// src/db/config.repository.ts
import { createDbClient } from './client';
import { config } from './schema';
import type { Env } from '../types/env';

/**
 * Configuration Repository
 *
 * Manages system configuration in D1 config table
 */
export class ConfigRepository {
  private db;

  constructor(env: Env) {
    this.db = createDbClient(env);
  }

  /**
   * Save Google OAuth2 credentials (Client ID, Secret, Redirect URI)
   */
  async saveGoogleCredentials(credentials: {
    clientId: string;
    clientSecret: string;
    redirectUri: string;
  }): Promise<void> {
    // Implementation:
    // Encrypt client secret before storage
    // INSERT or UPDATE config entries:
    // - google_client_id
    // - google_client_secret (encrypted)
    // - google_redirect_uri
  }

  /**
   * Get configuration value
   */
  async get(key: string): Promise<string | null> {
    // Implementation: Retrieve config value by key
  }

  /**
   * Get and decrypt configuration value
   */
  async getDecrypted(key: string): Promise<string | null> {
    // Implementation: Retrieve and decrypt config value
  }

  /**
   * Save Google OAuth tokens
   */
  async saveGoogleTokens(tokens: {
    accessToken: string;
    refreshToken: string;
    expiresAt: Date;
  }): Promise<void> {
    // Implementation:
    // INSERT or UPDATE config entries
    // - google_access_token
    // - google_refresh_token
    // - google_token_expires_at
  }

  /**
   * Save selected sheet configuration
   */
  async saveSheetConfig(sheetConfig: {
    sheetId: string;
    sheetName: string;
    sheetUrl: string;
  }): Promise<void> {
    // Implementation:
    // INSERT or UPDATE config entries
    // - selected_sheet_id
    // - selected_sheet_name
    // - selected_sheet_url
  }

  /**
   * Get Google access token
   */
  async getGoogleAccessToken(): Promise<string | null> {
    // Implementation: Retrieve access token from config
  }

  /**
   * Check if initial setup is complete
   */
  async isSetupComplete(): Promise<boolean> {
    // Implementation:
    // Check if google_access_token and selected_sheet_id exist
  }
}
```

### 9. 型定義

```typescript
// src/types/google.ts

/**
 * Google OAuth2 token response
 */
export interface TokenResponse {
  access_token: string;
  refresh_token: string;
  expires_in: number;
  token_type: string;
  scope: string;
}

/**
 * Spreadsheet metadata
 */
export interface SpreadsheetMetadata {
  id: string;
  name: string;
  url: string;
  createdTime: string;
  modifiedTime: string;
}

/**
 * Spreadsheet detailed information
 */
export interface SpreadsheetInfo {
  id: string;
  name: string;
  sheets: SheetInfo[];
}

/**
 * Individual sheet information
 */
export interface SheetInfo {
  sheetId: number;
  title: string;
  index: number;
  rowCount: number;
  columnCount: number;
}

/**
 * Sheet structure validation result
 */
export interface ValidationResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
  hasUsersSheet: boolean;
  hasRolesSheet: boolean;
}
```

## セキュリティ要件

### OAuth2セキュリティ
1. **State Parameter**: CSRF攻撃防止のためstate tokenを使用
2. **PKCE**: 可能であればPKCE (Proof Key for Code Exchange) を実装
3. **Token Storage**: Refresh tokenは暗号化してD1に保存
4. **Scope Minimization**: 必要最小限のスコープのみ要求（読み取り専用）
   - `https://www.googleapis.com/auth/spreadsheets.readonly` - Sheets読み取り専用
   - `https://www.googleapis.com/auth/drive.readonly` - Drive読み取り専用（シート一覧取得用）

### API Security
1. **Rate Limiting**: 認証エンドポイントにレート制限適用
2. **Input Validation**: すべてのユーザー入力を検証
3. **Error Handling**: 詳細なエラー情報を外部に漏らさない

## エラーハンドリング

### 認証エラー
- OAuth2認証失敗時の明確なエラーメッセージ
- トークン期限切れ時の自動リフレッシュ
- リフレッシュトークン無効時の再認証フロー

### シート選択エラー
- シートアクセス権限不足
- 必須シート(_Users, _Roles)の欠落
- シート構造の不正

### データベースエラー
- 設定保存失敗時のロールバック
- 接続エラー時のリトライ

## テスト要件

### 統合テスト
```typescript
// tests/integration/setup/google-auth.test.ts
describe('Google OAuth2 Integration', () => {
  it('should generate valid authorization URL', async () => {
    // Implementation: Test authorization URL generation
  });

  it('should exchange code for tokens', async () => {
    // Implementation: Test token exchange (with real Google API)
  });

  it('should save tokens to config table', async () => {
    // Implementation: Test token persistence
  });
});
```

### E2Eテスト (Playwright)
```typescript
// tests/e2e/setup/initial-setup.spec.ts
test('complete initial setup flow', async ({ page }) => {
  // Implementation:
  // 1. Navigate to /setup
  // 2. Click "Connect Google Account"
  // 3. Complete Google OAuth flow
  // 4. Select a sheet
  // 5. Save configuration
  // 6. Verify redirect to dashboard
});
```

## 完了条件

1. ✅ 初期設定画面が表示される
2. ✅ Google認証ボタンがクリック可能
3. ✅ Google OAuth2フローが正常に完了
4. ✅ 認証後、利用可能なシート一覧が表示される
5. ✅ シートを選択して保存できる
6. ✅ 設定がD1 configテーブルに保存される
7. ✅ 画面での初期設定が実環境で完全動作
8. ✅ 本番環境にデプロイして動作確認

## 実装上の注意

### Cloudflare Workers互換性
- **fetch API使用**: すべてのHTTP通信はfetchを使用
- **Node.js専用モジュール禁止**: googleapis等のNode.js専用パッケージは使用不可
- **REST API直接呼び出し**: Google APIs はREST endpoint経由で直接呼び出し
- **JSON解析**: すべてのレスポンスはJSON.parse()またはresponse.json()で処理
- **エラーハンドリング**: 非2xxレスポンスは明示的にエラーとして処理

## 環境設定チェックリスト

### Google Cloud Console設定（ユーザーが実施）
- [ ] Google Cloud Console プロジェクト作成
- [ ] OAuth 2.0 クライアント ID 作成（開発環境・本番環境）
- [ ] 承認済みリダイレクトURI 設定
  - 開発: `http://localhost:8787/api/setup/google-callback`
  - 本番: `https://your-app.workers.dev/api/setup/google-callback`
- [ ] Google Sheets API 有効化
- [ ] Google Drive API 有効化

### アプリケーション設定（初期設定画面で実施）
- [ ] 初期設定画面でGoogle Client ID入力
- [ ] 初期設定画面でGoogle Client Secret入力
- [ ] 初期設定画面でRedirect URI設定（自動生成も可能）
- [ ] D1 configテーブルに認証情報が暗号化保存されることを確認

## 参考リソース

- [Google OAuth 2.0 Documentation](https://developers.google.com/identity/protocols/oauth2)
- [Google OAuth 2.0 REST API](https://developers.google.com/identity/protocols/oauth2/web-server)
- [Google Sheets API v4 REST Reference](https://developers.google.com/sheets/api/reference/rest)
- [Google Drive API v3 REST Reference](https://developers.google.com/drive/api/v3/reference)
