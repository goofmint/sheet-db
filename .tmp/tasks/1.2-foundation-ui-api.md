# Task 1.2: 基盤UI・API構築

## 概要

Hono統合アーキテクチャを活用し、基本的なUIレイアウトとAPIエンドポイントを構築します。Honoの`hono/jsx`を使用してサーバーサイドレンダリング（SSR）でHTMLを生成し、クライアントサイドでのインタラクティブ機能を実装します。

## 目標

- React Router v6によるクライアントサイドルーティング
- 基本レイアウトコンポーネント（ヘッダー、サイドバー、メインコンテンツ）
- Honoアプリケーション基本構造とミドルウェア
- ヘルスチェックエンドポイント実装
- CORSとエラーハンドリングミドルウェア
- 本番環境デプロイと動作確認

## 技術スタック

- **バックエンド**: Hono (Cloudflare Workers)
- **フロントエンド**: Hono JSX (SSR) + hono/jsx/dom (クライアントサイド)
- **クライアントサイドレンダリング**: hono/jsx/domでのHooks (useState, useEffect等)
- **スタイリング**: インラインCSS（初期段階）
- **型安全性**: TypeScript strict mode

## アーキテクチャ設計

### Hono統合アーキテクチャの利点

1. **単一フレームワーク**: HonoでバックエンドとフロントエンドHTMLを統一管理
2. **高速SSR**: Cloudflare Workers上で高速なHTML生成
3. **シームレスなAPI統合**: 同一アプリケーション内でAPIとUIを提供
4. **小さなバンドルサイズ**: Honoは軽量で高速（カウンター例で2.8KB Brotli圧縮）
5. **Hono JSX Hooks**: `hono/jsx/dom`でuseState, useEffect等が使用可能
6. **クライアントサイドインタラクティブ**: Hono JSX Hooksによる動的UI実装

### ルーティング設計

```text
/ (root)
  └── HTML (SSR by Hono JSX)
      ├── / - ダッシュボード (SSR)
      ├── /settings - システム設定 (SSR)
      └── /setup - 初期設定 (SSR)

/api
  └── /health - ヘルスチェック
  └── /version - バージョン情報
```

### クライアントサイドレンダリングの仕組み

現在の実装では、ダッシュボード、システム設定、初期設定の各ページは純粋なSSRで提供されています。

将来的にインタラクティブコンポーネントが必要になった場合は、以下のアプローチでクライアントサイドレンダリングを追加可能です：

1. **SSRフェーズ**: Hono JSXでHTMLシェルを生成
2. **ハイドレーション**: `hono/jsx/dom`の`render()`でクライアントサイドコンポーネントをマウント
3. **インタラクティブ**: Hono JSX Hooksでステートとエフェクトをブラウザ上で実行

## ディレクトリ構造

```
src/
├── index.tsx                    # メインエントリポイント（既存）
├── middlewares/
│   ├── renderer.tsx            # JSXレンダラー（既存）
│   ├── error.ts                # エラーハンドリング（既存）
│   └── cors.ts                 # CORSミドルウェア（新規）
├── routes/
│   ├── api.ts                  # APIルート（既存）
│   └── ui/
│       ├── index.tsx           # UIルートメイン（新規）
│       ├── dashboard.tsx       # ダッシュボードページ（新規）
│       ├── settings.tsx        # システム設定ページ（新規）
│       └── setup.tsx           # 初期設定ページ（新規）
├── components/
│   ├── Layout.tsx              # レイアウトコンポーネント（SSR）
│   ├── Header.tsx              # ヘッダー（SSR）
│   ├── Sidebar.tsx             # サイドバー（SSR）
│   └── Dashboard.tsx           # ダッシュボード（SSR）
├── client/
│   ├── index.tsx               # クライアントサイドエントリポイント
│   └── components/
│       ├── Counter.tsx         # カウンターコンポーネント例（CSR）
│       └── InteractiveWidget.tsx # インタラクティブウィジェット例（CSR）
└── lib/
    └── api-client.ts           # APIクライアント
```

**注**: `src/client/` 配下はクライアントサイドでのみ実行され、`hono/jsx/dom`を使用します。`src/components/` 配下はサーバーサイドレンダリング用です。

## インターフェース設計

### 1. CORSミドルウェア (src/middlewares/cors.ts)

```typescript
// CORS middleware for API routes
// Configures Cross-Origin Resource Sharing headers

import { createMiddleware } from 'hono/factory';
import type { Env } from '../types/env';

/**
 * CORS middleware options
 */
interface CorsOptions {
  origin: string | string[];
  allowMethods?: string[];
  allowHeaders?: string[];
  exposeHeaders?: string[];
  credentials?: boolean;
  maxAge?: number;
}

/**
 * Create CORS middleware with specified options
 *
 * @param options - CORS configuration options
 * @returns Hono middleware for CORS handling
 *
 * Implementation:
 * - Check request origin against allowed origins
 * - Set appropriate CORS headers (Access-Control-Allow-*)
 * - Handle preflight OPTIONS requests
 * - Allow credentials if configured
 */
export function cors(options: CorsOptions) {
  // Middleware implementation
}

/**
 * Default CORS configuration
 * No restrictions as this is a BaaS (Backend as a Service)
 */
export const defaultCors = cors({
  origin: '*',
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Authorization'],
  maxAge: 86400, // 24 hours
});
```

### 2. UIルートメイン (src/routes/ui/index.tsx)

```typescript
// Main UI router that aggregates all UI page routes
// Combines dashboard, settings, and setup pages

import { Hono } from 'hono';
import type { Env } from '../../types/env';
import dashboardRoutes from './dashboard';
import settingsRoutes from './settings';
import setupRoutes from './setup';

const ui = new Hono<{ Bindings: Env }>();

/**
 * Aggregate all UI routes
 * Each page route handles its own HTML rendering
 */
ui.route('/', dashboardRoutes);
ui.route('/settings', settingsRoutes);
ui.route('/setup', setupRoutes);

export default ui;
```

### 3. ダッシュボードページルート (src/routes/ui/dashboard.tsx)

```typescript
// Dashboard page route - main admin panel view
// Serves HTML with Dashboard component

import { Hono } from 'hono';
import type { Env } from '../../types/env';
import { Layout } from '../../components/Layout';
import { Dashboard } from '../../components/Dashboard';

const dashboard = new Hono<{ Bindings: Env }>();

/**
 * GET / - Dashboard page
 *
 * Implementation:
 * - Render Layout component with Dashboard
 * - Include client-side script bundle that uses hono/jsx/dom
 * - Client script will mount interactive components using render()
 * - Set page title to "Dashboard"
 */
dashboard.get('/', (c) => {
  // Return HTML with Layout, Dashboard, and client script reference
});

export default dashboard;
```

### 4. システム設定ページルート (src/routes/ui/settings.tsx)

```typescript
// System settings page route
// Serves HTML for system configuration interface

import { Hono } from 'hono';
import type { Env } from '../../types/env';
import { Layout } from '../../components/Layout';

const settings = new Hono<{ Bindings: Env }>();

/**
 * GET /settings - System settings page
 *
 * Implementation:
 * - Render Layout component with Settings placeholder
 * - Include React Router client-side script
 * - Set page title to "System Settings"
 *
 * Note: Settings component will be implemented in Task 2.2
 * For now, display placeholder content
 */
settings.get('/', (c) => {
  // Return HTML with Layout and Settings placeholder
});

export default settings;
```

### 5. 初期設定ページルート (src/routes/ui/setup.tsx)

```typescript
// Initial setup page route
// Serves HTML for Google Sheets connection and configuration

import { Hono } from 'hono';
import type { Env } from '../../types/env';
import { Layout } from '../../components/Layout';

const setup = new Hono<{ Bindings: Env }>();

/**
 * GET /setup - Initial setup page
 *
 * Implementation:
 * - Render Layout component with Setup placeholder
 * - Include React Router client-side script
 * - Set page title to "Initial Setup"
 *
 * Note: Setup component will be implemented in Task 2.1
 * For now, display placeholder content
 */
setup.get('/', (c) => {
  // Return HTML with Layout and Setup placeholder
});

export default setup;
```

### 6. レイアウトコンポーネント (src/components/Layout.tsx)

```typescript
// Main layout component with header, sidebar, and content area
// Used as the base structure for all pages

import type { FC } from 'hono/jsx';
import { Header } from './Header';
import { Sidebar } from './Sidebar';

/**
 * Layout component props
 */
interface LayoutProps {
  children: any;
  title?: string;
}

/**
 * Layout component - provides consistent page structure
 *
 * Structure:
 * - Header: Top navigation bar with app title
 * - Sidebar: Left navigation menu
 * - Main: Content area where children are rendered
 *
 * Styling:
 * - CSS Grid layout for responsive design
 * - Flexbox for header and sidebar
 * - Mobile-friendly (sidebar collapses on small screens)
 */
export const Layout: FC<LayoutProps> = ({ children, title = 'Sheet DB Admin' }) => {
  // Component implementation with HTML structure
};
```

### 7. ヘッダーコンポーネント (src/components/Header.tsx)

```typescript
// Header component for top navigation bar
// Displays app title and user information

import type { FC } from 'hono/jsx';

/**
 * Header component - top navigation bar
 *
 * Features:
 * - Application title/logo
 * - Environment indicator (dev/production)
 * - User info placeholder (for future auth)
 *
 * Styling:
 * - Fixed height header
 * - Flexbox for alignment
 * - Background color differentiation
 */
export const Header: FC = () => {
  // Component implementation
};
```

### 8. サイドバーコンポーネント (src/components/Sidebar.tsx)

```typescript
// Sidebar component for navigation menu
// Provides links to different sections of the admin panel

import type { FC } from 'hono/jsx';

/**
 * Navigation menu item
 */
interface MenuItem {
  label: string;
  path: string;
  icon?: string;
}

/**
 * Sidebar component - left navigation menu
 *
 * Menu items:
 * - Dashboard (/)
 * - System Settings (/settings)
 * - Initial Setup (/setup)
 *
 * Features:
 * - Active link highlighting
 * - Icon support (optional)
 * - Collapsible on mobile
 *
 * Styling:
 * - Fixed width sidebar
 * - Vertical menu layout
 * - Hover states for menu items
 */
export const Sidebar: FC = () => {
  // Component implementation with menu items
};
```

### 9. ダッシュボードコンポーネント (src/components/Dashboard.tsx)

```typescript
// Dashboard component - main admin panel view
// Displays system overview and quick actions

import type { FC } from 'hono/jsx';

/**
 * Dashboard statistics card
 */
interface StatCard {
  title: string;
  value: string | number;
  description?: string;
}

/**
 * Dashboard component - main landing page
 *
 * Features:
 * - Welcome message
 * - System status cards (placeholder)
 * - Quick action buttons
 * - Recent activity (placeholder)
 *
 * Layout:
 * - Grid layout for stat cards
 * - Responsive design
 *
 * Note: Initial implementation shows placeholders
 * Future tasks will populate with real data
 */
export const Dashboard: FC = () => {
  // Component implementation with stat cards
};
```

### 10. クライアントサイドエントリポイント (src/client/index.tsx)

```typescript
// Client-side entry point using hono/jsx/dom
// Mounts interactive components after page load

import { render } from 'hono/jsx/dom';
import { Counter } from './components/Counter';

/**
 * Client-side initialization
 *
 * Implementation:
 * - Wait for DOMContentLoaded
 * - Find mount points in the HTML (data-component attributes)
 * - Mount interactive components using render()
 * - Handle hydration for SSR content
 */
function initializeClient() {
  // Mount Counter component if element exists
  const counterElement = document.querySelector('[data-component="counter"]');
  if (counterElement) {
    render(<Counter />, counterElement);
  }

  // Mount other interactive widgets as needed
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeClient);
} else {
  initializeClient();
}
```

### 11. クライアントサイドコンポーネント例 (src/client/components/Counter.tsx)

```typescript
// Example interactive component using hono/jsx/dom
// Demonstrates React Hooks usage (useState)

import { useState } from 'hono/jsx';
import type { FC } from 'hono/jsx';

/**
 * Counter component - interactive example
 *
 * Uses useState hook for client-side state management
 * Renders entirely on the client side using hono/jsx/dom
 *
 * Features:
 * - Increment/decrement buttons
 * - Real-time count display
 * - Click event handling
 */
export const Counter: FC = () => {
  const [count, setCount] = useState(0);

  return (
    <div style="padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px;">
      <h3>Counter Example</h3>
      <p>Count: {count}</p>
      <button onClick={() => setCount(count + 1)}>Increment</button>
      <button onClick={() => setCount(count - 1)}>Decrement</button>
    </div>
  );
};
```

### 12. APIクライアント (src/lib/api-client.ts)

```typescript
// API client for making requests from browser to Hono backend
// Provides type-safe methods for API communication

/**
 * API client configuration
 */
interface ApiClientConfig {
  baseUrl?: string;
  headers?: Record<string, string>;
}

/**
 * API response wrapper
 */
interface ApiResponse<T> {
  data?: T;
  error?: string;
  status: number;
}

/**
 * API client class for browser-side API calls
 *
 * Features:
 * - Automatic base URL detection
 * - JSON request/response handling
 * - Error handling and retry logic
 * - TypeScript type inference
 *
 * Methods:
 * - get<T>(path: string): Promise<ApiResponse<T>>
 * - post<T>(path: string, data: any): Promise<ApiResponse<T>>
 * - put<T>(path: string, data: any): Promise<ApiResponse<T>>
 * - delete<T>(path: string): Promise<ApiResponse<T>>
 */
export class ApiClient {
  // Implementation details
}

/**
 * Default API client instance
 */
export const api = new ApiClient({
  baseUrl: '/api',
});
```

### 13. ヘルスチェックAPI更新 (src/routes/api.ts)

```typescript
// Enhance existing health check endpoint with more information

import { Hono } from 'hono';
import type { Env } from '../types/env';

const api = new Hono<{ Bindings: Env }>();

/**
 * Health check response
 */
interface HealthResponse {
  status: 'healthy' | 'unhealthy';
  timestamp: string;
  environment: string;
  version: string;
  uptime: number;
  database?: {
    connected: boolean;
    responseTime?: number;
  };
}

/**
 * GET /api/health - Health check endpoint
 *
 * Returns:
 * - Service status
 * - Environment information
 * - Database connection status
 * - Response time metrics
 *
 * Usage: Monitoring and load balancer health checks
 */
api.get('/health', async (c) => {
  // Implementation: Check service and database health
});

/**
 * GET /api/version - Version information endpoint
 *
 * Returns application version from environment variables
 */
api.get('/version', (c) => {
  // Implementation: Return version from c.env.VERSION
});

export default api;
```

### 14. メインアプリケーション更新 (src/index.tsx)

```typescript
// Update main application to integrate UI routes and middleware

import { Hono } from 'hono';
import { renderer } from './middlewares/renderer';
import { errorHandler } from './middlewares/error';
import { defaultCors } from './middlewares/cors';
import apiRoutes from './routes/api';
import uiRoutes from './routes/ui';
import type { Env } from './types/env';

const app = new Hono<{ Bindings: Env }>();

/**
 * Global middleware configuration
 * Order matters: error handler -> CORS -> renderer
 *
 * CORS is set to allow all origins (*) since this is a BaaS
 * No credentials flag as we allow all origins
 */
app.use('*', errorHandler);
app.use('*', defaultCors);
app.use('*', renderer);

/**
 * Route configuration
 * API routes: /api/*
 * UI routes: /* (all pages served by UI router)
 */
app.route('/api', apiRoutes);
app.route('/', uiRoutes);

export default app;
```

## スタイリング方針

### 初期段階：インラインCSS

シンプルなインラインCSSを使用し、以下の基本スタイルを実装：

- **カラースキーム**:
  - Primary: `#3b82f6` (青)
  - Background: `#f9fafb` (明るいグレー)
  - Text: `#111827` (濃いグレー)
  - Border: `#e5e7eb` (薄いグレー)

- **レイアウト**:
  - Header高さ: `64px`
  - Sidebar幅: `250px`
  - コンテンツpadding: `24px`

- **レスポンシブ**:
  - モバイル: `< 768px` (サイドバー非表示、ハンバーガーメニュー)
  - タブレット: `768px - 1024px`
  - デスクトップ: `> 1024px`

## テスト戦略

### ユニットテスト

```typescript
// tests/unit/components/Layout.test.tsx

import { describe, it, expect } from 'vitest';
import { Layout } from '../../../src/components/Layout';

describe('Layout Component', () => {
  it('should render with default title', () => {
    // Test implementation
  });

  it('should render children content', () => {
    // Test implementation
  });

  it('should include Header and Sidebar', () => {
    // Test implementation
  });
});
```

### 統合テスト

```typescript
// tests/integration/api/health.test.ts

import { describe, it, expect } from 'vitest';
import app from '../../../src/index';

describe('Health Check API', () => {
  it('should return healthy status', async () => {
    // Test /api/health endpoint
  });

  it('should include environment information', async () => {
    // Test response structure
  });

  it('should check database connectivity', async () => {
    // Test database health check
  });
});
```

### E2Eテスト

```typescript
// tests/e2e/ui-navigation.test.ts

import { test, expect } from '@playwright/test';

test('should navigate to dashboard', async ({ page }) => {
  await page.goto('/');
  await expect(page.locator('h1')).toContainText('Sheet DB Admin');
});

test('should navigate between pages', async ({ page }) => {
  await page.goto('/');
  await page.click('a[href="/settings"]');
  await expect(page.url()).toContain('/settings');
});
```

## デプロイ戦略

### 本番環境デプロイ手順

1. **ビルド確認**: `npm run build` でTypeScriptエラーなし
2. **テスト実行**: `npm run test` で全テスト合格
3. **デプロイ**: `wrangler deploy --env production`
4. **動作確認**:
   - `/api/health` が正常レスポンス
   - ダッシュボードページが表示される
   - ナビゲーションが動作する

### 監視項目

- ヘルスチェックエンドポイントのレスポンスタイム
- エラーログ（Cloudflare Workers Dashboard）
- データベース接続状態

## 完了条件

- [x] React Router v6 セットアップ
- [x] 基本レイアウトコンポーネント作成
- [x] ナビゲーション・サイドバー実装
- [x] Honoアプリケーション基本構造
- [x] ヘルスチェックエンドポイント (`/api/health`)
- [x] CORS・基本ミドルウェア
- [x] APIクライアント基盤
- [x] 本番環境デプロイ・動作確認
- [x] `npm run test` 全テストパス
- [x] TypeScript型チェックエラーなし

## 依存関係

- **前提**: Task 1.1（プロジェクト初期化）完了
- **次タスク**: Task 1.3（D1データベース基盤）

## 推定時間

5時間

## 注意事項

### hono/jsx/domの活用

- **サーバーサイド**: Hono JSXで静的HTMLを生成（`src/components/`）
- **クライアントサイド**: `hono/jsx/dom`でインタラクティブコンポーネント実装（`src/client/`）
- **React Hooks**: useState, useEffect等が`hono/jsx/dom`で使用可能
- **バンドルサイズ**: 軽量（カウンター例で2.8KB Brotli圧縮）
- **jsxImportSource**: クライアントサイドコードは`hono/jsx/dom`を指定

### TypeScript設定

クライアントサイドコードでは`tsconfig.json`に以下を追加：

```json
{
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "hono/jsx/dom"
  }
}
```

サーバーサイドとクライアントサイドで異なる`jsxImportSource`を使用する場合は、ファイルごとに設定：

```typescript
/** @jsxImportSource hono/jsx/dom */
```

### パフォーマンス

- Cloudflare Workersのコールドスタート時間に注意
- 可能な限りバンドルサイズを小さく保つ
- 必要最小限のJavaScriptのみをクライアントに送信

### セキュリティ

- CORSは全オリジンを許可（BaaS特性のため）
- XSS対策のため、ユーザー入力は適切にエスケープ
- CSP（Content Security Policy）ヘッダーの設定を検討
- 認証・認可は後のタスクで実装

## 参考資料

- [Hono Documentation](https://hono.dev/)
- [Hono JSX](https://hono.dev/guides/jsx)
- [Hono JSX DOM (Client-side)](https://hono.dev/docs/guides/jsx-dom)
- [Cloudflare Workers](https://developers.cloudflare.com/workers/)
