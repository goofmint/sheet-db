# Task 1.2: 基盤UI・API構築

## 概要

Hono統合アーキテクチャを活用し、基本的なUIレイアウトとAPIエンドポイントを構築します。Honoの`hono/jsx`を使用してサーバーサイドレンダリング（SSR）でHTMLを生成し、クライアントサイドでのインタラクティブ機能を実装します。

## 目標

- React Router v6によるクライアントサイドルーティング
- 基本レイアウトコンポーネント（ヘッダー、サイドバー、メインコンテンツ）
- Honoアプリケーション基本構造とミドルウェア
- ヘルスチェックエンドポイント実装
- CORSとエラーハンドリングミドルウェア
- 本番環境デプロイと動作確認

## 技術スタック

- **バックエンド**: Hono (Cloudflare Workers)
- **フロントエンド**: Hono JSX (SSR) + React Router v6 (CSR)
- **スタイリング**: インラインCSS（初期段階）
- **型安全性**: TypeScript strict mode

## アーキテクチャ設計

### Hono統合アーキテクチャの利点

1. **単一フレームワーク**: HonoでバックエンドとフロントエンドHTMLを統一管理
2. **高速SSR**: Cloudflare Workers上で高速なHTML生成
3. **シームレスなAPI統合**: 同一アプリケーション内でAPIとUIを提供
4. **小さなバンドルサイズ**: Honoは軽量で高速

### ルーティング設計

```
/ (root)
  └── HTML (SSR by Hono JSX)
      └── Client-side routing (React Router v6)
          ├── / - ダッシュボード
          ├── /settings - システム設定
          └── /setup - 初期設定

/api
  └── /health - ヘルスチェック
  └── /version - バージョン情報
```

## ディレクトリ構造

```
src/
├── index.tsx                    # メインエントリポイント（既存）
├── middlewares/
│   ├── renderer.tsx            # JSXレンダラー（既存）
│   ├── error.ts                # エラーハンドリング（既存）
│   └── cors.ts                 # CORSミドルウェア（新規）
├── routes/
│   ├── api.ts                  # APIルート（既存）
│   └── ui.tsx                  # UIルート（新規）
├── components/
│   ├── Layout.tsx              # レイアウトコンポーネント
│   ├── Header.tsx              # ヘッダー
│   ├── Sidebar.tsx             # サイドバー
│   └── Dashboard.tsx           # ダッシュボード
└── lib/
    └── api-client.ts           # APIクライアント
```

## インターフェース設計

### 1. CORSミドルウェア (src/middlewares/cors.ts)

```typescript
// CORS middleware for API routes
// Configures Cross-Origin Resource Sharing headers

import { createMiddleware } from 'hono/factory';
import type { Env } from '../types/env';

/**
 * CORS middleware options
 */
interface CorsOptions {
  origin: string | string[];
  allowMethods?: string[];
  allowHeaders?: string[];
  exposeHeaders?: string[];
  credentials?: boolean;
  maxAge?: number;
}

/**
 * Create CORS middleware with specified options
 *
 * @param options - CORS configuration options
 * @returns Hono middleware for CORS handling
 *
 * Implementation:
 * - Check request origin against allowed origins
 * - Set appropriate CORS headers (Access-Control-Allow-*)
 * - Handle preflight OPTIONS requests
 * - Allow credentials if configured
 */
export function cors(options: CorsOptions) {
  // Middleware implementation
}

/**
 * Default CORS configuration for development
 */
export const devCors = cors({
  origin: '*',
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
});

/**
 * Production CORS configuration
 * Restricts origins to production domain only
 */
export const prodCors = cors({
  origin: ['https://sheet-db-production.workers.dev'],
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  maxAge: 86400, // 24 hours
});
```

### 2. UIルート (src/routes/ui.tsx)

```typescript
// UI routes for client-side application
// Serves HTML with React Router for SPA navigation

import { Hono } from 'hono';
import type { Env } from '../types/env';
import { Layout } from '../components/Layout';
import { Dashboard } from '../components/Dashboard';

const ui = new Hono<{ Bindings: Env }>();

/**
 * Root route - serves main application HTML
 *
 * Implementation:
 * - Render Layout component with Dashboard
 * - Include React Router client-side script
 * - Inject environment variables for client
 */
ui.get('/', (c) => {
  // Return HTML with Layout and Dashboard components
});

/**
 * Catch-all route for client-side routing
 * All non-API routes return the same HTML shell
 * React Router handles navigation on the client
 */
ui.get('*', (c) => {
  // Return same HTML shell for SPA routing
});

export default ui;
```

### 3. レイアウトコンポーネント (src/components/Layout.tsx)

```typescript
// Main layout component with header, sidebar, and content area
// Used as the base structure for all pages

import type { FC } from 'hono/jsx';
import { Header } from './Header';
import { Sidebar } from './Sidebar';

/**
 * Layout component props
 */
interface LayoutProps {
  children: any;
  title?: string;
}

/**
 * Layout component - provides consistent page structure
 *
 * Structure:
 * - Header: Top navigation bar with app title
 * - Sidebar: Left navigation menu
 * - Main: Content area where children are rendered
 *
 * Styling:
 * - CSS Grid layout for responsive design
 * - Flexbox for header and sidebar
 * - Mobile-friendly (sidebar collapses on small screens)
 */
export const Layout: FC<LayoutProps> = ({ children, title = 'Sheet DB Admin' }) => {
  // Component implementation with HTML structure
};
```

### 4. ヘッダーコンポーネント (src/components/Header.tsx)

```typescript
// Header component for top navigation bar
// Displays app title and user information

import type { FC } from 'hono/jsx';

/**
 * Header component - top navigation bar
 *
 * Features:
 * - Application title/logo
 * - Environment indicator (dev/production)
 * - User info placeholder (for future auth)
 *
 * Styling:
 * - Fixed height header
 * - Flexbox for alignment
 * - Background color differentiation
 */
export const Header: FC = () => {
  // Component implementation
};
```

### 5. サイドバーコンポーネント (src/components/Sidebar.tsx)

```typescript
// Sidebar component for navigation menu
// Provides links to different sections of the admin panel

import type { FC } from 'hono/jsx';

/**
 * Navigation menu item
 */
interface MenuItem {
  label: string;
  path: string;
  icon?: string;
}

/**
 * Sidebar component - left navigation menu
 *
 * Menu items:
 * - Dashboard (/)
 * - System Settings (/settings)
 * - Initial Setup (/setup)
 *
 * Features:
 * - Active link highlighting
 * - Icon support (optional)
 * - Collapsible on mobile
 *
 * Styling:
 * - Fixed width sidebar
 * - Vertical menu layout
 * - Hover states for menu items
 */
export const Sidebar: FC = () => {
  // Component implementation with menu items
};
```

### 6. ダッシュボードコンポーネント (src/components/Dashboard.tsx)

```typescript
// Dashboard component - main admin panel view
// Displays system overview and quick actions

import type { FC } from 'hono/jsx';

/**
 * Dashboard statistics card
 */
interface StatCard {
  title: string;
  value: string | number;
  description?: string;
}

/**
 * Dashboard component - main landing page
 *
 * Features:
 * - Welcome message
 * - System status cards (placeholder)
 * - Quick action buttons
 * - Recent activity (placeholder)
 *
 * Layout:
 * - Grid layout for stat cards
 * - Responsive design
 *
 * Note: Initial implementation shows placeholders
 * Future tasks will populate with real data
 */
export const Dashboard: FC = () => {
  // Component implementation with stat cards
};
```

### 7. APIクライアント (src/lib/api-client.ts)

```typescript
// API client for making requests from browser to Hono backend
// Provides type-safe methods for API communication

/**
 * API client configuration
 */
interface ApiClientConfig {
  baseUrl?: string;
  headers?: Record<string, string>;
}

/**
 * API response wrapper
 */
interface ApiResponse<T> {
  data?: T;
  error?: string;
  status: number;
}

/**
 * API client class for browser-side API calls
 *
 * Features:
 * - Automatic base URL detection
 * - JSON request/response handling
 * - Error handling and retry logic
 * - TypeScript type inference
 *
 * Methods:
 * - get<T>(path: string): Promise<ApiResponse<T>>
 * - post<T>(path: string, data: any): Promise<ApiResponse<T>>
 * - put<T>(path: string, data: any): Promise<ApiResponse<T>>
 * - delete<T>(path: string): Promise<ApiResponse<T>>
 */
export class ApiClient {
  // Implementation details
}

/**
 * Default API client instance
 */
export const api = new ApiClient({
  baseUrl: '/api',
});
```

### 8. ヘルスチェックAPI更新 (src/routes/api.ts)

```typescript
// Enhance existing health check endpoint with more information

import { Hono } from 'hono';
import type { Env } from '../types/env';

const api = new Hono<{ Bindings: Env }>();

/**
 * Health check response
 */
interface HealthResponse {
  status: 'healthy' | 'unhealthy';
  timestamp: string;
  environment: string;
  version: string;
  uptime: number;
  database?: {
    connected: boolean;
    responseTime?: number;
  };
}

/**
 * GET /api/health - Health check endpoint
 *
 * Returns:
 * - Service status
 * - Environment information
 * - Database connection status
 * - Response time metrics
 *
 * Usage: Monitoring and load balancer health checks
 */
api.get('/health', async (c) => {
  // Implementation: Check service and database health
});

/**
 * GET /api/version - Version information endpoint
 *
 * Returns application version and build info
 */
api.get('/version', (c) => {
  // Implementation: Return version from package.json
});

export default api;
```

### 9. メインアプリケーション更新 (src/index.tsx)

```typescript
// Update main application to integrate UI routes and middleware

import { Hono } from 'hono';
import { renderer } from './middlewares/renderer';
import { errorHandler } from './middlewares/error';
import { devCors, prodCors } from './middlewares/cors';
import apiRoutes from './routes/api';
import uiRoutes from './routes/ui';
import type { Env } from './types/env';

const app = new Hono<{ Bindings: Env }>();

/**
 * Global middleware configuration
 * Order matters: error handler -> CORS -> renderer
 */
app.use('*', errorHandler);
app.use('*', async (c, next) => {
  const corsMiddleware = c.env.ENVIRONMENT === 'production' ? prodCors : devCors;
  return corsMiddleware(c, next);
});
app.use('*', renderer);

/**
 * Route configuration
 * API routes: /api/*
 * UI routes: /* (catch-all for SPA)
 */
app.route('/api', apiRoutes);
app.route('/', uiRoutes);

export default app;
```

## スタイリング方針

### 初期段階：インラインCSS

シンプルなインラインCSSを使用し、以下の基本スタイルを実装：

- **カラースキーム**:
  - Primary: `#3b82f6` (青)
  - Background: `#f9fafb` (明るいグレー)
  - Text: `#111827` (濃いグレー)
  - Border: `#e5e7eb` (薄いグレー)

- **レイアウト**:
  - Header高さ: `64px`
  - Sidebar幅: `250px`
  - コンテンツpadding: `24px`

- **レスポンシブ**:
  - モバイル: `< 768px` (サイドバー非表示、ハンバーガーメニュー)
  - タブレット: `768px - 1024px`
  - デスクトップ: `> 1024px`

## テスト戦略

### ユニットテスト

```typescript
// tests/unit/components/Layout.test.tsx

import { describe, it, expect } from 'vitest';
import { Layout } from '../../../src/components/Layout';

describe('Layout Component', () => {
  it('should render with default title', () => {
    // Test implementation
  });

  it('should render children content', () => {
    // Test implementation
  });

  it('should include Header and Sidebar', () => {
    // Test implementation
  });
});
```

### 統合テスト

```typescript
// tests/integration/api/health.test.ts

import { describe, it, expect } from 'vitest';
import app from '../../../src/index';

describe('Health Check API', () => {
  it('should return healthy status', async () => {
    // Test /api/health endpoint
  });

  it('should include environment information', async () => {
    // Test response structure
  });

  it('should check database connectivity', async () => {
    // Test database health check
  });
});
```

### E2Eテスト

```typescript
// tests/e2e/ui-navigation.test.ts

import { test, expect } from '@playwright/test';

test('should navigate to dashboard', async ({ page }) => {
  await page.goto('/');
  await expect(page.locator('h1')).toContainText('Sheet DB Admin');
});

test('should navigate between pages', async ({ page }) => {
  await page.goto('/');
  await page.click('a[href="/settings"]');
  await expect(page.url()).toContain('/settings');
});
```

## デプロイ戦略

### 本番環境デプロイ手順

1. **ビルド確認**: `npm run build` でTypeScriptエラーなし
2. **テスト実行**: `npm run test` で全テスト合格
3. **デプロイ**: `wrangler deploy --env production`
4. **動作確認**:
   - `/api/health` が正常レスポンス
   - ダッシュボードページが表示される
   - ナビゲーションが動作する

### 監視項目

- ヘルスチェックエンドポイントのレスポンスタイム
- エラーログ（Cloudflare Workers Dashboard）
- データベース接続状態

## 完了条件

- [x] React Router v6 セットアップ
- [x] 基本レイアウトコンポーネント作成
- [x] ナビゲーション・サイドバー実装
- [x] Honoアプリケーション基本構造
- [x] ヘルスチェックエンドポイント (`/api/health`)
- [x] CORS・基本ミドルウェア
- [x] APIクライアント基盤
- [x] 本番環境デプロイ・動作確認
- [x] `npm run test` 全テストパス
- [x] TypeScript型チェックエラーなし

## 依存関係

- **前提**: Task 1.1（プロジェクト初期化）完了
- **次タスク**: Task 1.3（D1データベース基盤）

## 推定時間

5時間

## 注意事項

### Hono JSXの制約

- Hono JSXはReactではないため、`useState`や`useEffect`などのReact Hooksは使用不可
- クライアントサイドのインタラクティブ機能は、後のタスクで実装
- 初期段階は静的HTMLの生成に焦点

### パフォーマンス

- Cloudflare Workersのコールドスタート時間に注意
- 可能な限りバンドルサイズを小さく保つ
- 必要最小限のJavaScriptのみをクライアントに送信

### セキュリティ

- CORS設定は本番環境で厳格に制限
- XSS対策のため、ユーザー入力は適切にエスケープ
- CSP（Content Security Policy）ヘッダーの設定を検討

## 参考資料

- [Hono Documentation](https://hono.dev/)
- [Hono JSX](https://hono.dev/guides/jsx)
- [React Router v6](https://reactrouter.com/)
- [Cloudflare Workers](https://developers.cloudflare.com/workers/)
