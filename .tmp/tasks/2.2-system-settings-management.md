# Task 2.2: システム設定管理機能実装

## 概要

システム設定（configテーブル）の管理機能を実装します。管理画面からシステム全体の設定を変更できるようにします。

**重要**: ユーザー管理・ロール管理・データ管理はGoogleシートで行うため、管理画面ではシステム設定のみを扱います。

## 実装範囲

### 0. 事前修正

初期ユーザー作成時に、 _Roleシートに `Administrator` 自動で作成する（ロールが存在しない場合）。
初期ユーザーを作成後、そのロールの `users` 列に `[ユーザーID]` を追加する。

### 1. UI実装（管理画面）

未認証の場合、ログイン画面を出すこと。 `_User` シートにあるユーザー情報で認証し、かつ `Administrator` ロールを持つユーザーであることを確認する。
将来的に `User` シートではなく、`Cache` テーブルにキャッシュされたユーザー&ロール情報に変更するので、それを考慮した実装にすること（Googleシートへ直接アクセスしないこと）。

#### 1.1 システム設定画面
- **パス**: `/settings`
- **アクセス権限**: 管理者のみ
- **表示内容**:
  - Google API設定
  - ファイル管理設定
  - キャッシュ設定
  - セキュリティ設定
  - レート制限設定

```typescript
/**
 * システム設定画面コンポーネント
 * configテーブルの設定値を動的に表示・編集する
 */
interface SystemSettingsPageProps {
  // 設定値は動的に取得（key-valueペア）
  settings: Record<string, SettingValue>;
  // 設定定義（メタデータ）
  settingDefinitions: SettingDefinition[];
}

/**
 * 設定値の型定義
 */
type SettingValue = string | number | boolean | string[];

/**
 * 設定定義（メタデータ）
 * 新しい設定項目を追加する場合は、この定義を追加するだけ
 */
interface SettingDefinition {
  key: string; // 設定キー（例: 'maxFileSize'）
  label: string; // 表示名（例: '最大ファイルサイズ'）
  description: string; // 説明文
  category: string; // カテゴリ（例: 'file', 'cache', 'security'）
  type: 'string' | 'number' | 'boolean' | 'array' | 'password';
  defaultValue: SettingValue;
  validation?: {
    required?: boolean;
    min?: number;
    max?: number;
    pattern?: string;
    enum?: string[];
  };
  sensitive?: boolean; // 機密情報フラグ（パスワード等）
}

// 設定定義の例
const settingDefinitions: SettingDefinition[] = [
  {
    key: 'googleClientId',
    label: 'Google Client ID',
    description: 'Google OAuth 2.0クライアントID',
    category: 'google',
    type: 'string',
    defaultValue: '',
    validation: { required: true },
  },
  {
    key: 'maxFileSize',
    label: '最大ファイルサイズ',
    description: 'アップロード可能な最大ファイルサイズ（バイト）',
    category: 'file',
    type: 'number',
    defaultValue: 10485760, // 10MB
    validation: { min: 1024, max: 104857600 }, // 1KB - 100MB
  },
  {
    key: 'masterKey',
    label: 'Master Key',
    description: 'システムのマスターキー',
    category: 'security',
    type: 'password',
    defaultValue: '',
    validation: { required: true },
    sensitive: true,
  },
  {
    key: 'cacheTTL',
    label: 'キャッシュTTL',
    description: 'キャッシュの有効期限（秒）',
    category: 'cache',
    type: 'number',
    defaultValue: 300,
    validation: { min: 0, max: 86400 },
  },
  // 今後、新しい設定を追加する場合はここに追加するだけ
];
```

#### 1.2 設定フォームコンポーネント
```typescript
/**
 * 設定カテゴリ別のフォーム
 * カテゴリも動的に扱う
 */
interface SettingFormProps {
  category: string; // 動的なカテゴリ名
  definitions: SettingDefinition[]; // そのカテゴリの設定定義
  values: Record<string, SettingValue>; // 現在の設定値
  onChange: (key: string, value: SettingValue) => void;
  onSave: () => Promise<void>;
}
```

### 2. API実装

#### 2.1 設定取得API
```typescript
/**
 * GET /api/settings
 * すべての設定値と設定定義を取得
 *
 * レスポンス:
 * {
 *   settings: Record<string, SettingValue>, // 実際の設定値
 *   definitions: SettingDefinition[]       // 設定定義（メタデータ）
 * }
 */
interface GetSettingsResponse {
  settings: Record<string, SettingValue>;
  definitions: SettingDefinition[];
}
```

#### 2.2 設定更新API
```typescript
/**
 * PUT /api/settings
 * 設定値を更新
 *
 * リクエスト:
 * {
 *   key: string,
 *   value: string | number | boolean | array
 * }
 *
 * レスポンス:
 * {
 *   success: boolean,
 *   message: string
 * }
 */
interface UpdateSettingRequest {
  key: string;
  value: string | number | boolean | string[];
}

interface UpdateSettingResponse {
  success: boolean;
  message: string;
}
```

#### 2.3 設定一括更新API
```typescript
/**
 * PUT /api/settings/bulk
 * 複数の設定値を一括更新
 *
 * リクエスト:
 * {
 *   settings: Record<string, unknown>
 * }
 */
interface BulkUpdateSettingsRequest {
  settings: Record<string, string | number | boolean | string[]>;
}
```

### 3. バックエンド実装

#### 3.1 監査ログテーブル定義

設定変更を記録するための `audit_logs` テーブルをD1データベースに作成します。

```sql
CREATE TABLE IF NOT EXISTS audit_logs (
  id TEXT PRIMARY KEY,
  timestamp TEXT NOT NULL,
  user_id TEXT NOT NULL,
  action TEXT NOT NULL CHECK(action IN ('create', 'update', 'delete')),
  target_type TEXT NOT NULL CHECK(target_type IN ('config', 'user', 'role', 'data')),
  target_key TEXT NOT NULL,
  old_value TEXT,
  new_value TEXT,
  ip_address TEXT,
  user_agent TEXT
);

CREATE INDEX idx_audit_logs_timestamp ON audit_logs(timestamp);
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_target ON audit_logs(target_type, target_key);
```

```typescript
/**
 * 監査ログエントリ
 */
interface AuditLog {
  id: string; // ULID
  timestamp: string; // ISO 8601形式
  userId: string; // 操作を実行したユーザーID
  action: 'create' | 'update' | 'delete';
  targetType: 'config' | 'user' | 'role' | 'data';
  targetKey: string; // 対象のキー（例: 'maxFileSize'）
  oldValue?: string; // 変更前の値（JSON文字列）
  newValue?: string; // 変更後の値（JSON文字列）
  ipAddress?: string; // リクエスト元IPアドレス
  userAgent?: string; // ユーザーエージェント
}
```

#### 3.2 ConfigRepository拡張
```typescript
/**
 * configテーブルへのアクセスを提供
 * 既存のConfigRepositoryを拡張
 */
class ConfigRepository {
  /**
   * すべての設定値を取得
   */
  async getAllSettings(): Promise<Record<string, string>>;

  /**
   * 特定の設定値を取得
   */
  async getSetting(key: string): Promise<string | null>;

  /**
   * 設定値を更新
   */
  async updateSetting(key: string, value: string): Promise<void>;

  /**
   * 複数の設定値を一括更新
   */
  async updateSettings(settings: Record<string, string>): Promise<void>;

  /**
   * 設定値を削除
   */
  async deleteSetting(key: string): Promise<void>;
}
```

#### 3.3 AuditLogRepository
```typescript
/**
 * audit_logsテーブルへのアクセスを提供
 * Task 2.2では記録のみ実装し、取得・表示機能は将来のタスクで実装
 */
class AuditLogRepository {
  /**
   * 監査ログを記録
   */
  async logChange(log: Omit<AuditLog, 'id' | 'timestamp'>): Promise<void>;
}
```

#### 3.4 設定定義管理とバリデーション
```typescript
/**
 * 設定定義を管理するサービス
 * 設定項目の追加・削除を容易にする
 */
class SettingDefinitionService {
  private definitions: SettingDefinition[];

  constructor() {
    // 設定定義を一元管理
    // 新しい設定を追加する場合は、ここに追加するだけ
    this.definitions = this.loadDefinitions();
  }

  /**
   * すべての設定定義を取得
   */
  getAllDefinitions(): SettingDefinition[];

  /**
   * 特定のカテゴリの設定定義を取得
   */
  getDefinitionsByCategory(category: string): SettingDefinition[];

  /**
   * 特定のキーの設定定義を取得
   */
  getDefinition(key: string): SettingDefinition | null;

  /**
   * 設定定義を読み込む
   * 将来的にはDBから読み込むことも可能
   */
  private loadDefinitions(): SettingDefinition[] {
    return [
      {
        key: 'googleClientId',
        label: 'Google Client ID',
        description: 'Google OAuth 2.0クライアントID',
        category: 'google',
        type: 'string',
        defaultValue: '',
        validation: { required: true },
      },
      {
        key: 'maxFileSize',
        label: '最大ファイルサイズ',
        description: 'アップロード可能な最大ファイルサイズ（バイト）',
        category: 'file',
        type: 'number',
        defaultValue: 10485760,
        validation: { min: 1024, max: 104857600 },
      },
      {
        key: 'masterKey',
        label: 'Master Key',
        description: 'システムのマスターキー',
        category: 'security',
        type: 'password',
        defaultValue: '',
        validation: { required: true },
        sensitive: true,
      },
      // 設定項目を追加する場合は、ここに追加
    ];
  }
}

/**
 * 設定値のバリデーション
 * 設定定義に基づいて動的にバリデーション
 */
class SettingValidator {
  constructor(private definitionService: SettingDefinitionService) {}

  /**
   * 設定キーが有効かチェック
   */
  isValidKey(key: string): boolean {
    return this.definitionService.getDefinition(key) !== null;
  }

  /**
   * 設定値が有効かチェック
   * 設定定義に基づいて動的にバリデーション
   */
  isValidValue(key: string, value: unknown): boolean {
    const definition = this.definitionService.getDefinition(key);
    if (!definition) return false;

    // 型チェック
    if (!this.checkType(value, definition.type)) return false;

    // バリデーションルールチェック
    if (definition.validation) {
      return this.validateAgainstRules(value, definition.validation);
    }

    return true;
  }

  /**
   * 設定値を正規化
   */
  normalizeValue(key: string, value: unknown): string {
    // すべての値は文字列としてDBに保存
    // 型変換はバックエンドで実施
  }

  private checkType(value: unknown, type: string): boolean {
    // 型チェックロジック
  }

  private validateAgainstRules(value: unknown, rules: object): boolean {
    // バリデーションルールに基づくチェック
  }
}
```


## 設定項目定義

**重要**: 設定項目は動的に管理されます。新しい設定を追加する場合は、`SettingDefinitionService.loadDefinitions()`に定義を追加するだけです。

### 初期設定項目（例）

以下は初期実装で含める設定項目の例です。将来的に追加・削除が容易です。

#### Google API設定
- `googleClientId`: Google OAuth クライアントID
- `googleClientSecret`: Google OAuth クライアントシークレット
- `googleSheetId`: メインのGoogleシートID

#### ファイル管理設定
- `maxFileSize`: 最大ファイルサイズ（バイト）
- `allowedFileTypes`: 許可するファイルタイプ（MIMEタイプ配列）
- `storageType`: ストレージタイプ（'r2' | 'google_drive'）
- `r2AccountId`: R2アカウントID
- `r2AccessKeyId`: R2アクセスキー
- `r2SecretAccessKey`: R2シークレットキー
- `r2BucketName`: R2バケット名
- `googleDriveFolderId`: Google DriveフォルダID

#### キャッシュ設定
- `cacheTTL`: キャッシュTTL（秒）
- `cacheEnabled`: キャッシュ有効/無効

#### セキュリティ設定
- `jwtSecret`: JWT署名用シークレット
- `sessionTimeout`: セッションタイムアウト（秒）
- `masterKey`: システムのマスターキー

#### レート制限設定
- `rateLimitRequests`: 制限するリクエスト数
- `rateLimitWindow`: 時間窓（秒）

**設定追加方法**:
```typescript
// SettingDefinitionService.loadDefinitions()に追加
{
  key: 'newSetting',
  label: '新しい設定',
  description: '設定の説明',
  category: 'categoryName',
  type: 'string',
  defaultValue: '',
  validation: { required: true },
}
```

## ファイル構成

```
src/
├── routes/
│   └── api/
│       └── settings/
│           ├── get-settings.ts          # GET /api/settings
│           ├── update-setting.ts        # PUT /api/settings
│           └── bulk-update-settings.ts  # PUT /api/settings/bulk
├── db/
│   ├── config.repository.ts             # ConfigRepository拡張
│   ├── audit-log.repository.ts          # AuditLogRepository
│   └── migrations/
│       └── XXXX_create_audit_logs.sql   # 監査ログテーブル作成マイグレーション
├── services/
│   ├── setting-definition.service.ts    # 設定定義管理サービス
│   └── setting-validator.ts             # バリデーションサービス
└── routes/
    └── ui/
        └── settings.tsx                  # 設定画面UIルート
```

## テスト要件

### 1. ユニットテスト（Vitest）
```typescript
// config.repository.test.ts
describe('ConfigRepository', () => {
  test('getAllSettings - すべての設定を取得できる');
  test('getSetting - 特定の設定を取得できる');
  test('updateSetting - 設定を更新できる');
  test('updateSettings - 複数の設定を一括更新できる');
  test('deleteSetting - 設定を削除できる');
});

// setting-validator.test.ts
describe('SettingValidator', () => {
  test('isValidKey - 有効なキーを判定できる');
  test('isValidValue - 数値型の妥当性を検証できる');
  test('isValidValue - 配列型の妥当性を検証できる');
  test('isValidValue - 範囲外の値を拒否できる');
  test('normalizeValue - 値を正規化できる');
});

// audit-log.repository.test.ts
describe('AuditLogRepository', () => {
  test('logChange - 監査ログを記録できる');
  test('logChange - 設定変更時に正しいログが記録される');
});
```

### 2. E2Eテスト（Playwright）
```typescript
// settings.spec.ts
test('システム設定画面を表示できる', async ({ page }) => {
  // 管理画面にログイン
  // 設定画面に移動
  // 設定項目が表示されることを確認
});

test('設定値を更新できる', async ({ page }) => {
  // 設定画面を開く
  // maxFileSizeを変更
  // 保存ボタンをクリック
  // 成功メッセージが表示されることを確認
  // 画面をリロード
  // 変更した値が保持されていることを確認
});

test('無効な設定値は拒否される', async ({ page }) => {
  // 設定画面を開く
  // 範囲外の値を入力
  // エラーメッセージが表示されることを確認
});
```

## 完了条件

- [ ] audit_logsテーブルのマイグレーションが作成され、適用される
- [ ] AuditLogRepositoryが実装され、監査ログのCRUD操作ができる
- [ ] システム設定画面UIが実装され、configテーブルの設定値を表示・編集できる
- [ ] GET /api/settings APIが実装され、すべての設定値を取得できる
- [ ] PUT /api/settings APIが実装され、個別の設定値を更新できる
- [ ] PUT /api/settings/bulk APIが実装され、複数の設定値を一括更新できる
- [ ] ConfigRepositoryが拡張され、設定値のCRUD操作ができる
- [ ] SettingValidatorが実装され、設定値のバリデーションができる
- [ ] 設定変更時に監査ログが正しく記録される
- [ ] すべてのユニットテストが合格する
- [ ] すべてのE2Eテストが合格する
- [ ] 画面で設定変更が実環境で動作することを確認
- [ ] 本番環境にデプロイし、動作確認が完了

## 注意事項

### 役割分担の厳守
- **管理画面で管理**: システム設定（configテーブル）のみ
- **Googleシートで管理**: ユーザー・ロール・データ
- **実装禁止**: ユーザー管理画面・ロール管理画面

### セキュリティ
- 機密情報（シークレット、APIキー）は暗号化して保存
- 設定変更は監査ログに記録
- 管理者権限のみアクセス可能

### パフォーマンス
- 設定値は起動時にメモリキャッシュ
- 変更時のみDBアクセス
- 頻繁にアクセスされる設定は最適化

### エラーハンドリング
- 無効な設定値は明確なエラーメッセージで拒否
- DB更新失敗時は元の値を保持
- フォールバック禁止（エラー時は明確に失敗）
