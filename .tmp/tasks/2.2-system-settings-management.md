# Task 2.2: システム設定管理機能実装

## 概要

システム設定（configテーブル）の管理機能を実装します。管理画面からシステム全体の設定を変更できるようにします。

**重要**: ユーザー管理・ロール管理・データ管理はGoogleシートで行うため、管理画面ではシステム設定のみを扱います。

## 実装範囲

### 1. UI実装（管理画面）

#### 1.1 システム設定画面
- **パス**: `/settings`
- **アクセス権限**: 管理者のみ
- **表示内容**:
  - Google API設定
  - ファイル管理設定
  - キャッシュ設定
  - セキュリティ設定
  - レート制限設定

```typescript
/**
 * システム設定画面コンポーネント
 * configテーブルの設定値を表示・編集する
 */
interface SystemSettingsPageProps {
  // 現在の設定値を表示
  settings: SystemSettings;
}

interface SystemSettings {
  // Google API設定
  googleClientId: string;
  googleClientSecret: string;
  googleSheetId: string;

  // ファイル管理設定
  maxFileSize: number; // バイト単位
  allowedFileTypes: string[]; // ['image/jpeg', 'image/png', 'application/pdf']
  storageType: 'r2' | 'google_drive';

  // キャッシュ設定
  cacheTTL: number; // 秒単位
  cacheEnabled: boolean;

  // セキュリティ設定
  jwtSecret: string;
  sessionTimeout: number; // 秒単位

  // レート制限設定
  rateLimitRequests: number; // リクエスト数
  rateLimitWindow: number; // 時間窓（秒）
}
```

#### 1.2 設定フォームコンポーネント
```typescript
/**
 * 設定カテゴリ別のフォーム
 */
interface SettingFormProps {
  category: 'google' | 'file' | 'cache' | 'security' | 'rateLimit';
  values: Record<string, unknown>;
  onChange: (key: string, value: unknown) => void;
  onSave: () => Promise<void>;
}
```

### 2. API実装

#### 2.1 設定取得API
```typescript
/**
 * GET /api/settings
 * すべての設定値を取得
 *
 * レスポンス:
 * {
 *   settings: SystemSettings
 * }
 */
interface GetSettingsResponse {
  settings: SystemSettings;
}
```

#### 2.2 設定更新API
```typescript
/**
 * PUT /api/settings
 * 設定値を更新
 *
 * リクエスト:
 * {
 *   key: string,
 *   value: string | number | boolean | array
 * }
 *
 * レスポンス:
 * {
 *   success: boolean,
 *   message: string
 * }
 */
interface UpdateSettingRequest {
  key: string;
  value: string | number | boolean | string[];
}

interface UpdateSettingResponse {
  success: boolean;
  message: string;
}
```

#### 2.3 設定一括更新API
```typescript
/**
 * PUT /api/settings/bulk
 * 複数の設定値を一括更新
 *
 * リクエスト:
 * {
 *   settings: Record<string, unknown>
 * }
 */
interface BulkUpdateSettingsRequest {
  settings: Record<string, string | number | boolean | string[]>;
}
```

### 3. バックエンド実装

#### 3.1 ConfigRepository拡張
```typescript
/**
 * configテーブルへのアクセスを提供
 * 既存のConfigRepositoryを拡張
 */
class ConfigRepository {
  /**
   * すべての設定値を取得
   */
  async getAllSettings(): Promise<Record<string, string>>;

  /**
   * 特定の設定値を取得
   */
  async getSetting(key: string): Promise<string | null>;

  /**
   * 設定値を更新
   */
  async updateSetting(key: string, value: string): Promise<void>;

  /**
   * 複数の設定値を一括更新
   */
  async updateSettings(settings: Record<string, string>): Promise<void>;

  /**
   * 設定値を削除
   */
  async deleteSetting(key: string): Promise<void>;
}
```

#### 3.2 バリデーション
```typescript
/**
 * 設定値のバリデーション
 */
interface SettingValidator {
  /**
   * 設定キーが有効かチェック
   */
  isValidKey(key: string): boolean;

  /**
   * 設定値が有効かチェック
   */
  isValidValue(key: string, value: unknown): boolean;

  /**
   * 設定値を正規化
   */
  normalizeValue(key: string, value: unknown): string;
}

// バリデーションルール
const settingValidationRules = {
  maxFileSize: { type: 'number', min: 1024, max: 100 * 1024 * 1024 }, // 1KB - 100MB
  cacheTTL: { type: 'number', min: 0, max: 86400 }, // 0 - 24時間
  sessionTimeout: { type: 'number', min: 300, max: 86400 }, // 5分 - 24時間
  rateLimitRequests: { type: 'number', min: 1, max: 10000 },
  rateLimitWindow: { type: 'number', min: 1, max: 3600 },
  allowedFileTypes: { type: 'array', itemType: 'string' },
  storageType: { type: 'enum', values: ['r2', 'google_drive'] },
  cacheEnabled: { type: 'boolean' },
};
```

### 4. 設定の即座反映

#### 4.1 設定変更通知
```typescript
/**
 * 設定変更時に関連サービスに通知
 */
interface SettingChangeNotifier {
  /**
   * 設定変更を通知
   */
  notifyChange(key: string, newValue: string): Promise<void>;

  /**
   * 変更リスナーを登録
   */
  registerListener(
    key: string,
    callback: (newValue: string) => void | Promise<void>
  ): void;
}

// 使用例:
// キャッシュTTL変更時にキャッシュサービスを更新
notifier.registerListener('cacheTTL', async (newValue) => {
  await cacheService.updateTTL(parseInt(newValue));
});
```

## 設定項目定義

### Google API設定
- `googleClientId`: Google OAuth クライアントID
- `googleClientSecret`: Google OAuth クライアントシークレット
- `googleSheetId`: メインのGoogleシートID

### ファイル管理設定
- `maxFileSize`: 最大ファイルサイズ（バイト）
- `allowedFileTypes`: 許可するファイルタイプ（MIMEタイプ配列）
- `storageType`: ストレージタイプ（'r2' | 'google_drive'）
- `r2AccountId`: R2アカウントID
- `r2AccessKeyId`: R2アクセスキー
- `r2SecretAccessKey`: R2シークレットキー
- `r2BucketName`: R2バケット名
- `googleDriveFolderId`: Google DriveフォルダID

### キャッシュ設定
- `cacheTTL`: キャッシュTTL（秒）
- `cacheEnabled`: キャッシュ有効/無効

### セキュリティ設定
- `jwtSecret`: JWT署名用シークレット
- `sessionTimeout`: セッションタイムアウト（秒）

### レート制限設定
- `rateLimitRequests`: 制限するリクエスト数
- `rateLimitWindow`: 時間窓（秒）

## ファイル構成

```
src/
├── routes/
│   └── api/
│       └── settings/
│           ├── get-settings.ts          # GET /api/settings
│           ├── update-setting.ts        # PUT /api/settings
│           └── bulk-update-settings.ts  # PUT /api/settings/bulk
├── db/
│   └── config.repository.ts             # ConfigRepository拡張
├── services/
│   ├── setting-validator.ts             # バリデーションサービス
│   └── setting-change-notifier.ts       # 設定変更通知サービス
└── routes/
    └── ui/
        └── settings.tsx                  # 設定画面UIルート
```

## テスト要件

### 1. ユニットテスト（Vitest）
```typescript
// config.repository.test.ts
describe('ConfigRepository', () => {
  test('getAllSettings - すべての設定を取得できる');
  test('getSetting - 特定の設定を取得できる');
  test('updateSetting - 設定を更新できる');
  test('updateSettings - 複数の設定を一括更新できる');
  test('deleteSetting - 設定を削除できる');
});

// setting-validator.test.ts
describe('SettingValidator', () => {
  test('isValidKey - 有効なキーを判定できる');
  test('isValidValue - 数値型の妥当性を検証できる');
  test('isValidValue - 配列型の妥当性を検証できる');
  test('isValidValue - 範囲外の値を拒否できる');
  test('normalizeValue - 値を正規化できる');
});
```

### 2. E2Eテスト（Playwright）
```typescript
// settings.spec.ts
test('システム設定画面を表示できる', async ({ page }) => {
  // 管理画面にログイン
  // 設定画面に移動
  // 設定項目が表示されることを確認
});

test('設定値を更新できる', async ({ page }) => {
  // 設定画面を開く
  // maxFileSizeを変更
  // 保存ボタンをクリック
  // 成功メッセージが表示されることを確認
  // 画面をリロード
  // 変更した値が保持されていることを確認
});

test('無効な設定値は拒否される', async ({ page }) => {
  // 設定画面を開く
  // 範囲外の値を入力
  // エラーメッセージが表示されることを確認
});
```

## 完了条件

- [ ] システム設定画面UIが実装され、configテーブルの設定値を表示・編集できる
- [ ] GET /api/settings APIが実装され、すべての設定値を取得できる
- [ ] PUT /api/settings APIが実装され、個別の設定値を更新できる
- [ ] PUT /api/settings/bulk APIが実装され、複数の設定値を一括更新できる
- [ ] ConfigRepositoryが拡張され、設定値のCRUD操作ができる
- [ ] SettingValidatorが実装され、設定値のバリデーションができる
- [ ] 設定変更が即座に反映される仕組みが実装されている
- [ ] すべてのユニットテストが合格する
- [ ] すべてのE2Eテストが合格する
- [ ] 画面で設定変更が実環境で動作することを確認
- [ ] 本番環境にデプロイし、動作確認が完了

## 注意事項

### 役割分担の厳守
- **管理画面で管理**: システム設定（configテーブル）のみ
- **Googleシートで管理**: ユーザー・ロール・データ
- **実装禁止**: ユーザー管理画面・ロール管理画面

### セキュリティ
- 機密情報（シークレット、APIキー）は暗号化して保存
- 設定変更は監査ログに記録
- 管理者権限のみアクセス可能

### パフォーマンス
- 設定値は起動時にメモリキャッシュ
- 変更時のみDBアクセス
- 頻繁にアクセスされる設定は最適化

### エラーハンドリング
- 無効な設定値は明確なエラーメッセージで拒否
- DB更新失敗時は元の値を保持
- フォールバック禁止（エラー時は明確に失敗）
